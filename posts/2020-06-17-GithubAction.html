<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Lion Hair Dino - Hakyll 과 Github Action</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css" />
    </head>
    <body>
        <div id="header">
            <div id="logo">
                <a href="../">Lion Hair Dino</a>
            </div>
            <div id="navigation">
                <a href="../about.html">About</a>
                <a href="../archive.html">Archive</a>
            </div>
        </div>

        <div id="content">
            <h1>Hakyll 과 Github Action</h1>

            <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
<div class="info">
    Posted on June 17, 2020
    
</div>

<p>Hakyll 로 블로그를 돌리게 되면 컨텐츠를 등록할 때마다 다음 절차를 실행해야 한다.</p>
<ol type="1">
<li>컨텐츠를 수정</li>
<li>Hakyll 로 정적 사이트를 만들고,</li>
<li>사이트 소스 커밋,</li>
<li>생성된 사이트 커밋</li>
</ol>
<p>매 번 이렇게 하기에는 성가신 작업이다.</p>
<ol type="1">
<li>컨텐츠 수정</li>
<li>사이트 소스 커밋</li>
</ol>
<p>이렇게 하면 나머지는 자동으로 했으면 좋겠다. 이럴 때 Github Action 을 쓰면 된다. 이 전에는 Travis Ci, Circle Ci 등을 이용했는데, 2019년 말에 Github 자체에도 push, pull 등의 이벤트가 발생하면 자동으로 실행되는 기능이 생겼다.</p>
<p>이렇게 실행되는 작업을 workflow 라 부른다. workflow 는 여러 개의 액션들의 조합으로 만들어진다.</p>
<p>workflow 를 실행하는 머신을 runner 라고 부르는데, 클라우드 호스트라고 생각하면 된다. workflow 의 처음 액션이 호스트를 준비하는 것이다.</p>
<ol type="1">
<li>Ubuntu, Windows, MacOS 중 선택</li>
<li>현재 워크플로우가 들어있는 저장소를 runner 로 가져온다.</li>
<li>하스켈 설치 GHC 와 Cabal</li>
<li>매 번 호스트를 생성하고 하스켈을 설치하면, 하스켈 패키지를 받는데 30여분의 시간이 걸린다. 매 번 다운로드하지 않게 캐싱해 놓을 수 있다. 이 전에 해 놓은 캐싱이 있으면, 현재 환경에서 쓸 수 있는 캐싱인가 확인해서 새로 다운로드하지 않는다. 만약 환경이 달라졌거나 캐싱해 놓은게 없거나 하면 workflow 말미에 캐싱하도록 예약 한다.</li>
<li>Cabal Update</li>
<li>hakyll 빌드</li>
<li>hakyll 로 정적 사이트 빌드</li>
<li>_site 폴더에 만들어진 정적 사이트를 github page 와 물려있는 저장소에 커밋</li>
<li>예약된 post 캐싱 작업</li>
<li>예약된 post checkout 작업</li>
<li>프로세스 끝내기 (실행하면서 생긴 프로세스들을 정리)</li>
</ol>
<p>lionhairdino 사이트에 걸어 둔 workflow</p>
<pre><code>name: Haskell CI

on:
  push:
    branches: [ master ]

jobs:
  build-deploy:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-haskell@v1
      with:
        ghc-version: '8.8.2'
        cabal-version: '3.0'

    - name: Cache
      uses: actions/cache@v1
      env:
        cache-name: cache-cabal
      with:
        path: ~/.cabal
        key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/*.cabal') }}-${{ hashFiles('**/cabal.project') }}
        restore-keys: |
          ${{ runner.os }}-build-${{ env.cache-name }}-
          ${{ runner.os }}-build-
          ${{ runner.os }}-
    - name: Install dependencies
      run: |
        cabal update
        cabal build --only-dependencies
    - name: Build
      run: cabal build
    - name: Build Site
      run: cabal exec lionhairdino build
    - name: Deploy
      uses: peaceiris/actions-gh-pages@v3
      with:
        deploy_key: ${{ secrets.ACTIONS_DEPLOY_KEY }}
        publish_dir: _site
        publish_branch: master  
        External_repository: lionhairdino/lionhairdino.github.io</code></pre>

<div id="disqus_thread"></div>
<script>

var disqus_config = function () {
this.page.url = 'https://lionhairdino.github.io/posts/2020-06-17-GithubAction.html';
this.page.identifier = 'posts/2020-06-17-GithubAction.markdown';
};
(function() {
var d = document, s = d.createElement('script');
s.src = 'https://lionhairdino.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            
        </div>
        <div id="footer">
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
