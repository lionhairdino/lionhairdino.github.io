<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ko" lang="ko">

<head>
  <script>
    (function () {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        document.documentElement.classList.add('dark-mode');
      }
    })();

    function loadUtterances() {
      const savedTheme = localStorage.getItem('theme');
      const themeValue = savedTheme === 'dark' ? 'github-dark' : 'github-light';

      console.log("theme");
      console.log(themeValue);
      const script = document.createElement('script');
      script.src = 'https://utteranc.es/client.js';
      script.setAttribute('repo', 'lionhairdino/lionhairdino.github.io');
      script.setAttribute('issue-term', 'url');
      script.setAttribute('theme', themeValue);
      script.setAttribute('crossorigin', 'anonymous');
      script.async = true;
      document.body.appendChild(script);
    };

    function updateUtterancesTheme() {
      const savedTheme = localStorage.getItem('theme');
      const themeValue = savedTheme === 'dark' ? 'github-dark' : 'github-light';

      // Utterances iframe에 메시지 전송
      const utterances = document.querySelector('.utterances iframe');
      if (utterances) {
        utterances.contentWindow.postMessage(
          {type: 'set-theme', theme: themeValue},
          'https://utteranc.es'
        );
      }
    }

  </script>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>lionhairdino - 닉스의 Flake</title>
  
  <meta name="description" content="닉스의 Flake를 이용해서 특정 패키지를 덮어 쓰는 방법을 살펴 봤습니다." />
  <meta property="og:description" content="닉스의 Flake를 이용해서 특정 패키지를 덮어 쓰는 방법을 살펴 봤습니다." />
  
  <link rel="stylesheet" type="text/css" href="../css/default.css" />
  <link rel="icon" href="https://lionhairdino.github.io/favicon.svg" />
  <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino16px.png" sizes="16x16" />
  <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino24px.png" sizes="24x24" />
  <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino32px.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino48px.png" sizes="48x48" />
  <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino57px.png" sizes="57x57" />
  <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino60px.png" sizes="60x60" />
  <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino64px.png" sizes="64x64" />
  <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino72px.png" sizes="72x72" />
  <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino76px.png" sizes="76x76" />
  <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino114px.png" sizes="114x114" />
  <link rel="apple-touch-icon-precomposed" href="../images/favicon/Lionhairdino120px.png" sizes="120x120" />
  <link rel="apple-touch-icon-precomposed" href="../images/favicon/Lionhairdino144px.png" sizes="144x144" />
  <link rel="shortcut icon" href="../favicon.ico" />
  <link rel="apple-touch-icon-precomposed" href="../images/favicon/Lionhairdino152px.png" sizes="152x152" />
  <link rel="apple-touch-icon-precomposed" href="../images/favicon/Lionhairdino180px.png" sizes="180x180" />
  <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino192px.png" sizes="192x192" />
  <link rel="manifest" href="../site.webmanifest" />
  <link rel="mask-icon" href="https://lionhairdino.github.io/Lionhairdino_black.svg" color="#ff7500" />
  <meta name="msapplication-TileImage" content="/images/favicon/Lionhairdino144px.png" />
  <meta name="msapplication-TileColor" content="#ff7500" />
  <meta name="theme-color" content="#ffffff" />
  <meta property="og:type" content="website" />
  <meta property="og:title" content="닉스의 Flake" />
  <meta property="og:site_name" content="Lionhairdino" />
  <meta property="og:url" content="https://lionhairdino.github.io/posts/2024-12-02-flake.html" />
  
  <meta property="og:image" content="https://lionhairdino.github.io/images/state400px.png" />
  
  
  <meta name="keywords" content="Nix, Flake, Override, Overlay, NixOS, Package Manager">
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-E9WZ6VXGHP"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-E9WZ6VXGHP');
  </script>
  <script src="../script/copycode.js"></script>

  <script src="../script/darkmode.js"></script>
  <script async src="https://cse.google.com/cse.js?cx=9c53b4915cbb2605c"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.css" />
  <meta name="fediverse:creator" content="@lionhairdino@mastodon.social" />
  <link rel="alternate" type="application/rss+xml" title="상상 하스켈 - Lionhairdino" href="rss.xml" />
</head>

<body>
  <div id="header">
    <div style="display:inline-block;margin-right:5px;padding-top: 5px;" id="logo">
      <a href="../"><img style="width:30px;border:none" src="../images/favicon/Lionhairdino48px.png"></a>
    </div>
    <div style="display:inline-block;vertical-align: top;padding-top:5px;" id="navigation">
      <a href="../">lionhairdino</a>
      <a href="../about.html">about</a>
      <!--<a href="/archive.html">archive</a>-->
    </div>
    <div style="display:inline-block;font-size:0.8em;vertical-align: top;">
      <div style="display:inline-block;vertical-align: top;padding-top: 5px"></div>
      <div style="display:inline-block;vertical-align: top;padding-top: 11px; padding-left: 10px;"><a rel="me" href="https://mastodon.social/@lionhairdino"><img style="width:20px;border:none" src="../images/mastodon.svg"></a></div>
      <div style="display:inline-block;vertical-align: top;padding-top: 11px; padding-left: 2px;"><a href="https://lionhairdino.bsky.social"><img style="width:18px;border:none" src="../images/bluesky.svg"></a>
      </div>
      <div style="display:inline-block;vertical-align: top;padding-top: 11px; padding-left: 2px;"><a href="https://discordapp.com/users/lionhairdino#7687"><img style="width:20px;border:none" src="../images/discord.svg"></a></div>
      <div style="display:inline-block;vertical-align: top;padding-top: 11px; padding-left: 2px;"><a href="https://x.com/lionhairdino"><img style="width:15px;border:none" src="../images/X.svg"></a></div>
      <div style="display:inline-block;vertical-align: top;padding-top: 11px; padding-left: 2px;"><a href="https://linkedin.com/in/lionhairdino-l-baaa54244"><img style="width:20px;border:none" src="../images/linkedin.svg"></a></div>
      <div style="display:inline-block;vertical-align: top;padding-top: 11px; padding-left: 2px;"><a href="https://github.com/lionhairdino"><img style="width:20px;border:none" src="../images/github.svg"></a></div>
      <div style="display:inline-block;vertical-align: top;padding-top: 11px; padding-left: 2px;"><a href="https://www.threads.net/@linohairdino"><img style="width:20px;border:none" src="../images/threads.svg"></a></div>
    </div>
    <div>
      <div style="display:inline-block;width:180px;">
        <div class="gcse-searchbox-only"></div>
        <div><button id="theme-toggle">
            <script>
              const savedTheme = localStorage.getItem('theme');
              if (savedTheme === 'dark')
                document.write("☉");
              else
                document.write("☾");
            </script>
          </button></div>
      </div>
    </div>
    <div>
      여기 글들은 일종의 질문입니다. 용어 선택도 학계, 업계에서 쓰는 걸로 되어 있지 않고, 틀린 내용이 있을 수도 있습니다. 여기 글을 처음 읽는 분은, 먼저 <a href="../warning.html">주의문</a>을 꼭 읽어보세요.
    </div>
  </div>
  <div class="js-toc-content">
    <h1>닉스의 Flake</h1>
    <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
<div class="info">
    Posted on December  2, 2024
    
</div>

<p>Nixpkgs Manual <a href="https://ryantm.github.io/nixpkgs/" class="uri">https://ryantm.github.io/nixpkgs/</a></p>
<p>※ Flake 영단어 뜻은 작고 얇은 <strong>조각</strong>을 의미합니다. 아침에 먹던 그 콘프레이크의 프레이크와 같은 뜻입니다. Nix는 라틴어로 눈이란 뜻입니다. 닉스 로고는 <strong>Snow Flake</strong>(눈송이)입니다. 대기의 온도와 습도에 따라 복잡한 모양을 띠어서 이름으로 썼나 싶습니다.</p>
<p>닉스 패키지 매니저 2.4부터 도입된, 아직은 실험적 기능이라 합니다만, 실험적인 것 치고는 너무 많은 곳에 쓰이고 있습니다. 어쨌든 공식적으론 여전히 실험적 특징이라 합니다.(2024.11 현재)</p>
<p>닉스 만으로 각 종 설치, 환경을 완벽히 재현할 수 있으면 좋겠지만, 현재의 닉스는 어떤 패키지의 어떤 버전을 쓰고 있는지 명확히 선언하지 않고 있습니다. 예를 들어, 어떤 채널에 있는 패키지를 참조한다고 한다면, 해당 채널이 고정된 상태가 아니라면 항상 같은 패키지를 가져 온다고 보장할 수 없습니다. 이를 보완하기 위해, 의존성 검사에 필요한 정보들을 추가로 저장해야 나중에 재현 가능성reproduicibily을 높일 수 있습니다. 이를 위해, 닉스에 새로운 기능으로 <strong>Flake</strong>를 도입했습니다.</p>
<p>Flake는 의존성과 버전 정보를 <code>flake.lock</code> 파일에 저장합니다. Nixpkgs 어떤 커밋을 쓰고 있는지 커밋 해시값까자 모두 기록합니다.</p>
<p><code>flake.lock</code>에 <code>flake.nix</code>의 <code>input</code>에 써 준 모든 것들의 데이터 소스, 해시값, 버전을 기록합니다.</p>
<p>패키지를 의존성은 <code>[ ]</code>로 표시하겠습니다.<br />
<code>A[가1]</code>, <code>B[A]</code>이라고 할 때, 만일 <code>A</code>패키지 제작자가 <code>가1</code>의 버전을 <code>가2</code>를 쓰게 바꿨는데도 <strong>자신의 버전 번호를 변경하지 않았다면,</strong> <code>B[A[가1]]</code>이었던 게 <code>B[A[가2]]</code>가 되는데, 이 때 <code>B</code>가 <code>가2</code>와 호환이 안되는 경우가 있을 수 있습니다. 이런 경우를 Flake는 방지할 수 있고, 클래식 닉스는 할 수 없습니다.</p>
<p>한 마디로 클래식 닉스는 <code>B[A]</code>라고 쓰지만, Flake는 (<code>flake.lock</code>을 이용해서) 항상 <code>B[A[가1]]</code>라고 지정한다고 볼 수 있습니다.</p>
<p>Flake 기능을 도입하기 전에 쓰던 설정 파일인 <code>configuration.nix</code>도 <code>flake.nix</code>에서 모듈로 불러 옵니다.(<code>configuration.nix</code> 파일도 하나의 모듈 파일입니다.)</p>
<p>※ 처음 볼 때 Flake를 여기 저기 쓰는데, 해석에 좀 혼란이 있었습니다. 마치 닉스라 하면, 닉스 OS인지, 패키지 매니저인지, 언어를 뜻하는 지 혼란스러웠던 것처럼요.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode default"><code class="sourceCode default"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>flake.nix 파일</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  |------------- 외부 모듈 flake 파일</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  |                     |------------- 외부 모듈 flake 파일 ...</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  |                     |------------- 외부 모듈 flake 파일 ...</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  |                     ...</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  |------------- 외부 모듈 flake 파일</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  |                     |------------- 외부 모듈 flake 파일 ...</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  ...                   ...</span></code></pre></div>
<p>Flake 기능의 시작점이 되는 <code>flake.nix</code> 파일을 그냥 flake라 부를 때도 있고, flake 구성에 쓰이는 모든 파일들을 flake라 부르기도 하고, 기능 자체를 Flake라 부르기도 합니다.</p>
<p>※ Flake의 물리적인 모양은, <code>flake.nix</code>와 선택적으로 <code>flake.lock</code>을 포함한 디렉토리입니다.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode default"><code class="sourceCode default"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>my-flake/</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  flake.nix -- Flake 정의 파일 (필수)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  flake.lock -- 버전 고정 (선택)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  src/  -- 프로젝트 소스 코드</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  default.nix -- 기존 Nix 방식과 호환을 위해 추가</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  shell.nix -- 개발 환경 (선택)</span></code></pre></div>
<p><strong>flake.nix 기본 구성</strong><br />
(모든 flake 파일의 구성이 아니라, <code>flake.nix</code>파일의 구성입니다.)</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">description</span> <span class="op">=</span> ...<span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">inputs</span> <span class="op">=</span> ...<span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">outputs</span> <span class="op">=</span> <span class="op">{</span> <span class="va">self</span><span class="op">,</span> <span class="va">nixpkgs</span> <span class="op">}</span>:</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>      <span class="va">lib</span> <span class="op">=</span>                  <span class="op">;</span><span class="co"># 공통 유틸리티들이 들어 있는, 스탠다드 라이브러리 같은 것</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>      <span class="va">overlays</span> <span class="op">=</span>             <span class="op">;</span><span class="co"># 닉스pkgs를 수정, 확장하기 위한 오버레이 정의</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>      <span class="va">packages</span> <span class="op">=</span>             <span class="op">;</span><span class="co"># default, x86_64-linux, aarch64-darwin...에 맞는 패키지 정의</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>                             ;<span class="co"># nix run 실행할 때 참조</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>      <span class="va">apps</span> <span class="op">=</span>                 <span class="op">;</span><span class="co"># nix run 으로 애플리케이션을 실행</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>      <span class="va">checks</span> <span class="op">=</span>               <span class="op">;</span><span class="co"># 테스트 정의</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>      <span class="va">defaultPacakage</span> <span class="op">=</span>      <span class="op">;</span><span class="co"># Flake가 실행될 때 기본적으로 사용할 패키지</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>                             ;<span class="co"># nix build 에서 참조</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>      <span class="va">defaultApp</span> <span class="op">=</span>           <span class="op">;</span><span class="co"># Flake가 실행될 때 기본적으로 실행할 애플리케이션</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>                             ;<span class="co"># nix run 와 연동</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>      <span class="va">devShells</span> <span class="op">=</span>            <span class="op">;</span><span class="co"># 개발 환경을 정의</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>                             ;<span class="co"># nix develop 이 호출</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>      <span class="va">nixosConfigurations</span> <span class="op">=</span>  <span class="op">;</span><span class="co"># NixOS 시스템 설정 정의</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>      <span class="va">darwinConfigurations</span> <span class="op">=</span> <span class="op">;</span><span class="co"># macOS 시스템 설정 정의</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>      <span class="va">templates</span> <span class="op">=</span>            <span class="op">;</span><span class="co"># 프로젝트를 생성할 수 있는 템플릿</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>                             ;<span class="co"># nix flake init에서 씁니다.</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>설정 파일을 작성할 때 쓸 도구(<code>lib</code>)들을 준비하고, 기본 패키지에서 사용자 입맛에 맞게 바꾸거나 추가할 패키지(<code>overlays</code>)를 설정하고, 설치할 패키지(<code>packages</code>)를 정의합니다</p>
<p>시스템을 영구적으로 변경하는 <code>sudo nixos-rebuild switch</code>에서만 이 파일을 읽어 들이는 게 아니라, <code>nix run</code>, <code>nix build</code>,… 등의 명령어들도 이 파일을 읽어 참조합니다.</p>
<h1 id="flake의-모듈-시스템">Flake의 모듈 시스템</h1>
<p><code>flake.nix</code>에서 불러 들일 모듈은 다음과 같은 구조를 가지고 있습니다. 아래 정의는 역시 닉스 언어의 <strong>함수 표현식</strong>입니다. <strong>모듈 시스템</strong>이 자동으로 값을 넣어주는, 선언 없이 사용 가능한, 몇 개의 매개 변수를 가지고 있습니다. (※ 함수라고, 사용자가 어디에 직접 적용하거나 그러진 않습니다. 함수형 언어에서 데이터와 관련 메소드들을 묶어서 가지고 다니기에 가장 적합한 구조는 함수입니다.)
<a href="https://nixos.wiki/wiki/NixOS_modules">NixOS modules - NixOS Wiki</a></p>
<p><code>flake.nix</code> 파일의 구성이 아니라 <strong>Flake 모듈 파일의 기본 구성</strong></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">lib</span><span class="op">,</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">config</span><span class="op">,</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">options</span><span class="op">,</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">pkgs</span><span class="op">,</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 위의 것들이 자주 보이는데, 아래도 표준이라 합니다.</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="va">modulePath</span><span class="op">,</span> </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="va">configDir</span><span class="op">,</span> </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="va">system</span><span class="op">,</span> </span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="va">parentConfig</span><span class="op">,</span> </span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="va">optionsPath</span><span class="op">,</span> </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="va">specialArgs</span><span class="op">,</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>: </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 위 매개 변수로 들어오는 인자들을 닉스OS 모듈 시스템의 표준 인자라 합니다.</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 특별히 넘겨 주는 코드를 쓰지 않아도 자동으로 넘어 옵니다.</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 표준 인자만 받는 모듈일 경우 위는 통채로 생략하고, 파일 시작을 아래부터 할 수도 있습니다. </span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 다른 모듈에서 불러 오기</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  <span class="va">imports</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="ss">./xxx.nix</span> <span class="co"># 파일 경로만(절대, 상대 모두 가능) 써주면 됩니다.</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">];</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="va">options</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  <span class="va">config</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>  <span class="va">foo</span>.<span class="va">bar</span>.<span class="va">enable</span> <span class="op">=</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 다른 옵션 선언</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ...</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="매개-변수">매개 변수</h3>
<p>※ 나중에 위 매개 변수에 값을 넘기는 건, 모듈 시스템이 알아서 합니다.</p>
<ul>
<li><code>lib</code>: nixpkg에 내장된 함수 라이브러리로, Nix 표현식을 위한 실용적인 함수들을 제공합니다.</li>
<li><code>config</code>: 이어지는 모듈 섹션에서 쓰일, 현재 환경에 있는 모든 옵션값들이 들어 있는 집합</li>
<li><code>options</code>: 현재 환경에 있는 모든 모듈에 정의되어 있는 모든 옵션 집합</li>
<li><code>pkgs</code>: 모든 nixpkgs 패키지와 유틸리티 함수를 갖고 있는 컬렉션,
입문자는 기본 값으로 <code>nixpkgs.legacyPackages."${system}"</code>이 고정되어 있다고 생각해도 됩니다.</li>
<li><code>modulePath</code>: NixOS에서만 유효한 매개 변수, NixOS의 모듈 디렉토리를 나타내며 <code>nixpkgs/nixos/modules</code>를 가리킵니다. <code>NIX_PATH</code> 환경 변수에서 가져옵니다.</li>
</ul>
<p>※ 기본값이 아닌 값을 서브 모듈에 넘길 때 <code>nixpkgs.lib.nixosSystem</code> 함수의 <code>specialArgs</code> 매개 변수를 이용하거나, <code>_module.args</code> 옵션을 이용합니다.</p>
<h3 id="imports">imports</h3>
<p>디폴트 모듈셋은 <code>nixos/modules/module-list.nix</code>에 정의되어 있고, 이들은 명시적으로 <code>imports</code>에 추가하지 않아도 됩니다.</p>
<p>표현식들에서 자주 쓰이는 내장 함수 <code>import some.nix</code>는 <code>some.nix</code>파일에 있는 닉스 표현식을 로드하는 것으로 (<code>some.nix</code> 같은 파일들은 특별히 지정된 구조를 가질 필요는 없습니다.) <code>imports = [./module.nix]</code>와 혼동하지 마세요.</p>
<h2 id="다른-flake-소스에서-소프트웨어-설치">다른 Flake 소스에서 소프트웨어 설치</h2>
<p>nixpkgs가 아닌 다른 소스에서 설치 할 수 있습니다. (※ 보통 nixpkgs에 최신 버전이 아직 안 올라 왔을 경우 자주 씁니다.)</p>
<p>코드들은 <a href="https://nixos-and-flakes.thiscute.world/nixos-with-flakes/nixos-flake-and-module-system#install-system-packages-from-other-flakes">NixOS &amp; Flakes Book</a>에서 발췌했습니다.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># flake.nix 예시</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">inputs</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">nixpkgs</span>.<span class="va">url</span> <span class="op">=</span> <span class="st">&quot;github:NixOS/nixpkgs/nixos-24.11&quot;</span><span class="op">;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># helix의 데이터 소스를 추가한다. helix의 마스터 브랜치 </span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">helix</span>.<span class="va">url</span> <span class="op">=</span> <span class="st">&quot;github:helix-editor/helix/master&quot;</span><span class="op">;</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="va">outputs</span> <span class="op">=</span> inputs@<span class="op">{</span> <span class="va">self</span><span class="op">,</span> <span class="va">nixpkgs</span><span class="op">,</span> <span class="op">...</span> <span class="op">}</span>: <span class="op">{</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="va">nixosConfigurations</span>.<span class="va">my-nixos</span> <span class="op">=</span> nixpkgs.lib.nixosSystem <span class="op">{</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>      <span class="va">system</span> <span class="op">=</span> <span class="st">&quot;x86_64-linux&quot;</span><span class="op">;</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>      <span class="va">specialArgs</span> <span class="op">=</span> <span class="op">{</span> <span class="kw">inherit</span> inputs<span class="op">;</span> <span class="op">};</span> <span class="co"># (가)</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>      <span class="va">modules</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        <span class="ss">./configuration.nix</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># { _module.args = { inherit inputs; };} (나)</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (가)와 (나)가 하는 일은 같다. 원하는 걸로 골라 쓰면 됩니다.</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>      <span class="op">];</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>flake.nix</code>의 <code>inputs</code>에서 데이터 소스(위 <code>helix</code>같은 것)를 설정해 주면, <code>specailArgs = { inherit inputs }</code>를 통해 <code>configuration.nix</code>에 넘겨서, 이 소스를 가져다 쓸 수 있습니다. <code>inputs</code> 인자를 받기 위해 매개 변수 <code>inputs</code>를 추가했습니다.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># configuration.nix</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">config</span><span class="op">,</span> <span class="va">pkgs</span><span class="op">,</span> <span class="va">inputs</span><span class="op">,</span> <span class="op">...</span> <span class="op">}</span>:</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ...</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">environment</span>.<span class="va">systemPackages</span> <span class="op">=</span> <span class="kw">with</span> pkgs<span class="op">;</span> <span class="op">[</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    git</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    vim</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    wget</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 여기서, helix input 소스에서 가져와 helix 패키지를 설치합니다.</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    inputs.helix.packages.<span class="st">&quot;</span><span class="sc">${</span>pkgs.system<span class="sc">}</span><span class="st">&quot;</span>.helix</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">];</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ...</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>※ <code>configuration.nix</code>파일에 선언해서 영구적으로 설치하는 게 아닌, 시도만 해보려면 <code>nix run github:helix-editor/helix/master</code>를 이용할 수 있습니다.</p>
<h2 id="모듈-불러오기">모듈 불러오기</h2>
<p>https://nixos.org/manual/nixos/unstable/#sec-modularity</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># packages.nix</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">config</span><span class="op">,</span> <span class="co"># 최소 두 개의 매개 변수를 가집니다.</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">pkgs</span><span class="op">,</span>   <span class="co"># 닉스 모듈 시스템이 값을 넣어 줍니다.</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>: <span class="op">{</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="va">imports</span> <span class="op">=</span> <span class="op">[</span> <span class="co"># 외부 모듈을 불러올 때</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span><span class="bu">import</span> <span class="ss">./special-fonts-1.nix</span> <span class="op">{</span><span class="kw">inherit</span> config pkgs<span class="op">;})</span> <span class="co"># (1)</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="ss">./special-fonts-2.nix</span> <span class="co"># (2)</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">];</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="va">fontconfig</span>.<span class="va">enable</span> <span class="op">=</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>불러 올import 모듈은 두 가지 방식으로 적어 줄 수 있습니다.</p>
<p><code>(1)</code>은 불러 온import 함수를 바로 실행하는 구문입니다. 인자로 넘겨 주려면, 그냥 <strong>config</strong>와, <strong>pkgs</strong>를 쓰면 되지 않나 했는데, <code>{inherit config pkgs}</code>는 <code>{config = config; pkgs = pkgs}</code>와 같은 구문입니다. 함수 실행 결과를 <code>imports</code> 배열에 원소로 추가하고 있습니다.</p>
<p><code>(2)</code>도 닉스가 모듈로 간주하고, 내부 함수가 필요로 하는 <code>config</code>, <code>pkgs</code>를 명시하지 않아도, 모듈 시스템이 <strong>자동으로 전달</strong>합니다.
<code>import ./special-fonts-2.nix { config = config; pkgs = pkgs; }</code>를 실행하고 있다고 보면 됩니다.</p>
<p><code>special-fonts-1.nix</code> 파일이나 <code>special-fonts-2</code> 둘 모두 모듈이고, 아래 같은 모양을 가지고 있을 겁니다.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">config</span><span class="op">,</span> <span class="va">pkgs</span><span class="op">,</span> <span class="op">...}</span>: <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Configuration stuff ...</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>위와 같은 <code>packages.nix</code> 모듈 파일을 만들면, 다른 Flake 어디서든 <code>import</code> 할 수 있습니다. 주로 <code>configuration.nix</code>의 <code>imports</code> 항목이나, <code>flake.nix</code>의 <code>modules</code> 항목에서 볼 수 있습니다.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>    nixosConfigurations.mySystem = nixpkgs.lib.nixosSystem <span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>      <span class="va">system</span> <span class="op">=</span> <span class="st">&quot;x86_64-linux&quot;</span><span class="op">;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>      <span class="va">modules</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>        <span class="ss">./packages.nix</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">];</span></span></code></pre></div>
<h3 id="mkbefore-함수">mkBefore 함수</h3>
<p>※ 만일 <code>configuration.nix</code>와 <code>someModule.nix</code>에서 모두 <code>environment.systemPackages</code> 옵션을 정의하면, 닉스OS가 알아서 병합merge합니다. 그런데, 병합 순서가 있습니다. <code>configuration.nix</code>에 있는 것들이 가장 끝에 병합됩니다. 순서를 바꾸려면 유틸리티에 있는 <code>mkBefore</code>를 씁니다.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">boot</span>.<span class="va">kernelModules</span> <span class="op">=</span> mkBefore <span class="op">[</span><span class="st">&quot;kvm-intel&quot;</span><span class="op">]</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p><code>kernelMondules</code> 중에 가장 먼저 <code>kvm-intel</code>이 로드 됩니다. 두 모듈에 리스트 타입이 아닌데 겹치는 옵션이 있으면 병합을 못하고, 오류가 납니다.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">services</span>.<span class="va">httpd</span>.<span class="va">adminAddr</span> <span class="op">=</span> pkgs.lib.mkForce <span class="st">&quot;bob@example.org&quot;</span><span class="op">;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="mkforce-함수">mkForce 함수</h3>
<p>강제로 하나만 살아 남게 하려면 <code>mkForce</code>를 씁니다. 위에서 본 모듈 코드 모양을 보면 <code>{config, pkgs, ...}</code>로 <code>config</code>를 항상 받습니다. 모든 모듈들을 읽어 합칠 건 합치고, 겹치는 것들 처리하고 나온 결과를 묶어, 이 <code>config</code>를 통해 받습니다. 생각이 약간 복잡해지는데요. 모든 모듈들이 받는 <code>config</code>는, 어딘가에서 모듈 내용을 읽어들여 정리한 결과를 받는다니, 자신이 자신의 것을 이용하는 재귀적인 모양이 됩니다. Nix언어는 <strong>지연 평가lazy</strong>하기 때문에 이렇게 하는 게 가능합니다. (개별 항목이 자기 자신에 의존하는 경우는 안됩니다.) <a href="https://lionhairdino.github.io/posts/2020-07-07-fix.html">아마 fixpoint로 구현하고 있을 겁니다.</a></p>
<h3 id="nixos-option-명령어">nixos-option 명령어</h3>
<p>여기 저기 동일한 옵션이 정의 되어 있어서, 다 병합하고 나면 어느게 살아남는지 궁금할 때 다음 명령어를 써서 알아 볼 수 있습니다.</p>
<pre><code>$ nixos-option services.xserver.enable</code></pre>
<p>※ 불러 들인 모듈에 있는 옵션에 접근하려면, <code>config</code>를 이용하면 됩니다. 어떻게? <code>config</code>는 재귀적 결과물이라 이렇게 하는 게 가능합니다. 몇 단계를 걸쳐 모듈을 불러오든 모두 <code>config</code>를 통해 접근할 수 있습니다.</p>
<h2 id="overriding-과-overlays">Overriding 과 Overlays</h2>
<h3 id="overriding">Overriding</h3>
<p><code>pkgs</code>에 있는 닉스 패키지를 <code>override</code> 함수로 사용자가 덮어 씌울 수 있습니다. <code>override</code> 함수로 사용자 빌드 매개 변수를 정의할 수 있고, 덮어 씌워진 값을 가진, 새로운 derivation을 돌려 줍니다.
예)</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>pkgs.fcitx5<span class="op">-</span>rime.override <span class="op">{</span> <span class="va">rimeDataPkgs</span> <span class="op">=</span> <span class="op">[</span> <span class="ss">./rime-data-flypy</span> <span class="op">];</span> <span class="op">}</span></span></code></pre></div>
<p><code>fcitx5-rime</code>에 있는 <code>rimeDataPkgs</code> 매개 변수를, 커스텀 패키지 <code>rime-data-flypy</code>를 이용해 <code>override</code>합니다. <code>override</code>함수는 해당 필드만 덮어 씌워진 새로운 derivation을 만들어 냅니다.</p>
<p>패키지에 <code>override</code>로 덮어 씌울 수 있는 매개 변수가 뭐가 있는지 알아보는 방법<br />
<code>nix repl -f '&lt;nixpkgs&gt;'</code><br />
<code>:e pkgs.hello</code></p>
<div class="sourceCode" id="cb14"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">callPackage</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">lib</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">stdenv</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">fetchurl</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">nixos</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">testers</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">hello</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>:</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 위에 있는 것들은 override로 덮어 씌우고</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>stdenv.mkDerivation <span class="op">(</span><span class="va">finalAttrs</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 아래 있는 항목들은 overrideAttrs로 덮어 씌웁니다.</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="va">pname</span> <span class="op">=</span> <span class="st">&quot;hello&quot;</span><span class="op">;</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="va">version</span> <span class="op">=</span> <span class="st">&quot;2.12.1&quot;</span><span class="op">;</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="va">src</span> <span class="op">=</span> fetchurl <span class="op">{</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="va">url</span> <span class="op">=</span> <span class="st">&quot;mirror://gnu/hello/hello-</span><span class="sc">${</span>finalAttrs.version<span class="sc">}</span><span class="st">.tar.gz&quot;</span><span class="op">;</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="va">sha256</span> <span class="op">=</span> <span class="st">&quot;sha256-jZkUKv2SV28wsM18tCqNxoCZmLxdYH2Idh9RLibH2yA=&quot;</span><span class="op">;</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="va">doCheck</span> <span class="op">=</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  ...</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="op">})</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>hellowWithDebug = pkgs.hello.overrideAttrs <span class="op">(</span><span class="va">finalAttrs</span><span class="op">:</span> <span class="va">previousAttrs</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co">#                                             인자1         인자2</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">doCheck</span> <span class="op">=</span> <span class="cn">false</span><span class="op">;</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="op">})</span></span></code></pre></div>
<p>인자 두 개가 커링된 람다 함수로 보면 됩니다.</p>
<p>위 hello 파일에 보이는 속성들 말고, <code>stdenv.mkDerivation</code>에 있는 <code>separateDebugInfo</code>같은 속성도 덮어 씌울 수 있습니다.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>hellowWithDebug = pkgs.hello.overrideAttrs <span class="op">(</span><span class="va">finalAttrs</span><span class="op">:</span> <span class="va">previousAttrs</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">separateDebugInfo</span> <span class="op">=</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="op">})</span></span></code></pre></div>
<p><code>:e stdenv.mkDerivation</code>으로 매개 변수 목록을 뽑아 볼 수 있습니다.</p>
<h3 id="overlays">overlays</h3>
<p>디폴트 nixpkgs 인스턴스에서, <strong>전역적</strong>으로 derivations을 수정하기 위해 제공되는 기능입니다. 전역적이란 말이 무슨 말이냐 하면, <code>override</code>로 덮어 씌운 건 해당 패키지만 바뀌치기 하고, 다른 패키지가 해당 패키지를 참조하고 있다면, 그 때는 여전히 수정되지 않은 패키지를 참조합니다. 글로벌하게 바꾸려면 <code>overlays</code>를 씁니다.</p>
<p>Flake를 쓰지 않는 닉스에서는 <code>~/.config/nixpkgs/overlays.nix</code> 또는 <code>~/.config/nixpkgs/overlays/*.nix</code> 파일들로 overlays를 구성할 수 있었지만, Flake는 재현 가능성을 위해 Git 저장소를 벗어나는 설정을 쓸 수 없습니다.</p>
<p>Home Manager와 NixOS는 <code>nixpkgs.overlays</code> 옵션을 가지고 있습니다.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ./overlays/default.nix</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">config</span><span class="op">,</span> <span class="va">pkgs</span><span class="op">,</span> <span class="va">lib</span><span class="op">,</span> <span class="op">...</span> <span class="op">}</span>:</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">nixpkgs</span>.<span class="va">overlays</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Overlay 1: 상속 관계를 표현하기 위해 `self`와 `super`를 씁니다.</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span><span class="va">self</span><span class="op">:</span> <span class="va">super</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>      <span class="va">google-chrome</span> <span class="op">=</span> super.google<span class="op">-</span>chrome.override <span class="op">{</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">commandLineArgs</span> <span class="op">=</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;--proxy-server='https=127.0.0.1:3128;http=127.0.0.1:3128'&quot;</span><span class="op">;</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>      <span class="op">};</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">})</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Overlay 2: 새로운 것과 오래된 것을 나타내는 의미로 `final`과 `prev`를 씁니다.</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span><span class="va">final</span><span class="op">:</span> <span class="va">prev</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>      <span class="va">steam</span> <span class="op">=</span> prev.steam.override <span class="op">{</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">extraPkgs</span> <span class="op">=</span> <span class="va">pkgs</span><span class="op">:</span> <span class="kw">with</span> pkgs<span class="op">;</span> <span class="op">[</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>          keyutils</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>          libkrb5</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>          libpng</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>          libpulseaudio</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>          libvorbis</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>          stdenv.cc.cc.lib</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>          xorg.libXcursor</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>          xorg.libXi</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>          xorg.libXinerama</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>          xorg.libXScrnSaver</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">];</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">extraProfile</span> <span class="op">=</span> <span class="st">&quot;export GDK_SCALE=2&quot;</span><span class="op">;</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>      <span class="op">};</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">})</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Overlay 3: 다른 파일에 overlays를 정의합니다.</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ./overlays/overlay3/default.nix 의 내용은 위와 같습니다.</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># `(final: prev: { xxx = prev.xxx.override { ... }; })`</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span><span class="bu">import</span> <span class="ss">./overlay3</span><span class="op">)</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>  <span class="op">];</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>위와 같이 작성하고 <code>flake.nix</code>는 아래와 같이 작성해서 오버레이를 불러 옵니다.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ./flake.nix</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">inputs</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="va">outputs</span> <span class="op">=</span> inputs@<span class="op">{</span> <span class="va">nixpkgs</span><span class="op">,</span> <span class="op">...</span> <span class="op">}</span>: <span class="op">{</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">nixosConfigurations</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>      <span class="va">my-nixos</span> <span class="op">=</span> nixpkgs.lib.nixosSystem <span class="op">{</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">system</span> <span class="op">=</span> <span class="st">&quot;x86_64-linux&quot;</span><span class="op">;</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">modules</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>          <span class="ss">./configuration.nix</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>          <span class="op">(</span><span class="bu">import</span> <span class="ss">./overlays</span><span class="op">)</span> <span class="co"># 이렇게 폴더만 써주면, default.nix를 찾는다.</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">];</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>      <span class="op">};</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>폴더에 있는 모든 오버레이를 불러 오려면</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">pkgs</span><span class="op">,</span> <span class="va">lib</span><span class="op">,</span> <span class="op">...</span> <span class="op">}</span>:</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">overlays</span> <span class="op">=</span> <span class="bu">builtins</span>.attrValues <span class="op">(</span><span class="bu">builtins</span>.readDir <span class="ss">./overlays</span><span class="op">);</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">overlays</span> <span class="op">=</span> overlays<span class="op">;</span> <span class="op">}</span></span></code></pre></div>
<h3 id="specialargs">specialArgs</h3>
<div class="sourceCode" id="cb20"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>nixosConfigurations = <span class="op">{</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">my-nixos</span> <span class="op">=</span> nixpkgs.lib.nixosSystem <span class="kw">rec</span> <span class="op">{</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">system</span> <span class="op">=</span> ...</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    specialArgs = s1 <span class="co"># &lt;-- 자동으로 modules에 넘어 갑니다.</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    modules = <span class="op">[</span>m1 m2<span class="op">]</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p><code>m1</code>과 <code>m2</code>는 <code>s1</code>에 접근 가능하다. <code>specialArgs</code>는 자동으로 모듈에 넘어 갑니다.</p>
<h2 id="rust-overlay의-flake.nix-분석">rust-overlay의 flake.nix 분석</h2>
<p><a href="https://github.com/oxalica/rust-overlay/blob/c65e91d4a33abc3bc4a892d3c5b5b378bad64ea1/flake.nix">rust-overlay/flake.nix</a>에서 가져 왔습니다.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">description</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="st">    Pure and reproducible overlay for binary distributed rust toolchains.</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="st">    A compatible but better replacement for rust overlay of github:mozilla/nixpkgs-mozilla.</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="st">  ''</span><span class="op">;</span> <span class="co"># ''로 여러 줄 텍스트를 넣어 줄 수 있다.</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="va">inputs</span> <span class="op">=</span> <span class="op">{</span> <span class="co"># flake의 입력</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">nixpkgs</span>.<span class="va">url</span> <span class="op">=</span> <span class="st">&quot;github:NixOS/nixpkgs/nixpkgs-unstable&quot;</span><span class="op">;</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="va">outputs</span> <span class="op">=</span> <span class="op">{</span> <span class="va">self</span><span class="op">,</span> <span class="va">nixpkgs</span> <span class="op">}</span>@<span class="va">inputs</span><span class="op">:</span> <span class="kw">let</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">inherit</span> (<span class="va">nixpkgs</span>) <span class="va">lib</span>; <span class="co"># lib = nixpkgs.lib 보통 유틸리티 함수를 쓸 때 필요한 것 같다.</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="va">inherit</span> (<span class="va">lib</span>) <span class="va">filterAttrs</span> <span class="va">mapAttrs'</span> <span class="va">replaceStrings</span>;  </span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># filterAttrs = lib.filterAttrs 속성 필터</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mapAttrs' = lib.mapAttrs' 속성 매핑</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># replaceStrings = lib.replaceStrings 문자열 치환</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="va">forEachSystem</span> <span class="op">=</span> lib.genAttrs lib.systems.flakeExposed<span class="op">;</span> <span class="co"># 함수 정의</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                            지원되는 시스템 목록 제공</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                            x86_64-linux, aarch64-linux, x86_64-darwin 같은 것들</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    <span class="va">overlay</span> <span class="op">=</span> <span class="bu">import</span> <span class="ss">./.</span><span class="op">;</span> <span class="co"># 현재 디렉토리에서 오버레이 가져 오기. 아마도 default.nix?</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>    <span class="va">defaultDistRoot</span> <span class="op">=</span> <span class="bu">import</span> <span class="ss">./lib/dist-root.nix</span><span class="op">;</span></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>    <span class="va">mkManifests</span> <span class="op">=</span> <span class="va">distRoot</span><span class="op">:</span> <span class="bu">import</span> <span class="ss">./lib/manifests.nix</span> <span class="op">{</span> <span class="kw">inherit</span> lib distRoot<span class="op">;</span> <span class="op">};</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                                                    distRoot = lib.distRoot</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rust 도구 체인 인터페이스 빌더</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Builder to construct `rust-bin` interface on an existing `pkgs`.</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This would be immutable, non-intrusive and (hopefully) can benefit from</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># flake eval-cache.</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Note that this does not contain compatible attrs for mozilla-overlay.</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rust 바이너리 인터페이스</span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>    <span class="va">mkRustBin</span> <span class="op">=</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a>      <span class="op">{</span> <span class="va">distRoot</span> <span class="op">?</span> defaultDistRoot <span class="op">}</span>: <span class="co"># 값이 들어 오지 않으면, defaultDistRoot를 사용</span></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>                                      <span class="co"># 매개 변수의 기본값을 정의하는 구문</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>      <span class="va">pkgs</span><span class="op">:</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a>      lib.fix <span class="op">(</span><span class="va">rust-bin</span><span class="op">:</span> <span class="bu">import</span> <span class="ss">./lib/rust-bin.nix</span> <span class="op">{</span></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">inherit</span> lib pkgs<span class="op">;</span> <span class="co"># pkgs = lib.pkgs</span></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>        <span class="kw">inherit</span> <span class="op">(</span>pkgs.rust<span class="op">)</span> toRustTarget<span class="op">;</span> <span class="co"># toRustTarget = pkgs.rust.toRustTarget</span></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>        <span class="kw">inherit</span> <span class="op">(</span>rust<span class="op">-</span>bin<span class="op">)</span> nightly<span class="op">;</span> <span class="co"># nightly = rust-bin.nightly</span></span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>        <span class="va">manifests</span> <span class="op">=</span> mkManifests distRoot<span class="op">;</span> <span class="co"># manifest: 파일 메타 정보 목록</span></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>                                          <span class="co"># 아마도 버전 목록?</span></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>                                          <span class="co"># {이름, 버전, 의존성, ...}을 받아 메니페스트 생성</span></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a>      <span class="op">});</span></span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>  <span class="kw">in</span> <span class="op">{</span></span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a>    <span class="va">lib</span> <span class="op">=</span> <span class="op">{</span> </span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>      <span class="va">_internal</span> <span class="op">=</span> <span class="op">{</span> <span class="co"># 내부에서만 사용할 라이브러리</span></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>        <span class="va">defaultManifests</span> <span class="op">=</span> mkManifests defaultDistRoot<span class="op">;</span></span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>      <span class="op">};</span></span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>      <span class="kw">inherit</span> mkRustBin<span class="op">;</span> <span class="co"># 외부에서 접근 가능한 Rust 도구 체인 빌더</span></span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>    <span class="va">overlays</span> <span class="op">=</span> <span class="op">{</span> <span class="co"># 패키지에서 특정 부분만 바뀌 치기 위한 오버레이</span></span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a>      <span class="va">default</span> <span class="op">=</span> overlay<span class="op">;</span> <span class="co"># 현재 폴더에서 가져온 오버레이(위에서 정의된 변수)</span></span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>      <span class="va">rust-overlay</span> <span class="op">=</span> overlay<span class="op">;</span></span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: Flake outputs except `overlay[s]` are not stabilized yet.</span></span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>    <span class="va">packages</span> <span class="op">=</span> <span class="co"># 다양한 Rust 버전을 정의</span></span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span></span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>        <span class="va">select</span> <span class="op">=</span> <span class="va">version</span><span class="op">:</span> <span class="va">comps</span><span class="op">:</span> <span class="co"># 함수</span></span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a>          <span class="kw">if</span> comps <span class="op">?</span> default <span class="kw">then</span></span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>            comps.default <span class="op">//</span> <span class="op">{</span></span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>              <span class="va">minimal</span> <span class="op">=</span> comps.minimal <span class="kw">or</span> <span class="op">(</span><span class="bu">throw</span> <span class="st">&quot;missing profile 'minimal' for </span><span class="sc">${</span>version<span class="sc">}</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>          <span class="kw">else</span></span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>            <span class="cn">null</span><span class="op">;</span></span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>        <span class="va">result</span> <span class="op">=</span> <span class="va">rust-bin</span><span class="op">:</span> <span class="co"># 함수</span></span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>          mapAttrs' <span class="op">(</span><span class="va">version</span><span class="op">:</span> <span class="va">comps</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>            <span class="va">name</span> <span class="op">=</span> <span class="kw">if</span> version == <span class="st">&quot;latest&quot;</span></span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>              <span class="kw">then</span> <span class="st">&quot;rust&quot;</span> <span class="co"># latest면 그냥 rust</span></span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a>              <span class="kw">else</span> <span class="st">&quot;rust_</span><span class="sc">${</span>replaceStrings <span class="op">[</span><span class="st">&quot;.&quot;</span><span class="op">]</span> <span class="op">[</span><span class="st">&quot;_&quot;</span><span class="op">]</span> version<span class="sc">}</span><span class="st">&quot;</span><span class="op">;</span></span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a>                  <span class="co"># ex) rust_1_81_0</span></span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>            <span class="va">value</span> <span class="op">=</span> select version comps<span class="op">;</span></span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a>          <span class="op">})</span> rust<span class="op">-</span>bin.stable <span class="op">//</span></span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a>          mapAttrs' <span class="op">(</span><span class="va">version</span><span class="op">:</span> <span class="va">comps</span><span class="op">:</span> <span class="op">{</span> <span class="co"># 고차 함수를 인자로 넘기고 있다.</span></span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>            <span class="va">name</span> <span class="op">=</span> <span class="kw">if</span> version == <span class="st">&quot;latest&quot;</span></span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>              <span class="kw">then</span> <span class="st">&quot;rust-nightly&quot;</span></span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a>              <span class="kw">else</span> <span class="st">&quot;rust-nightly_</span><span class="sc">${</span>version<span class="sc">}</span><span class="st">&quot;</span><span class="op">;</span></span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a>            <span class="va">value</span> <span class="op">=</span> select version comps<span class="op">;</span></span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>          <span class="op">})</span> rust<span class="op">-</span>bin.nightly <span class="op">//</span></span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a>          mapAttrs' <span class="op">(</span><span class="va">version</span><span class="op">:</span> <span class="va">comps</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a>            <span class="va">name</span> <span class="op">=</span> <span class="kw">if</span> version == <span class="st">&quot;latest&quot;</span></span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a>              <span class="kw">then</span> <span class="st">&quot;rust-beta&quot;</span></span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a>              <span class="kw">else</span> <span class="st">&quot;rust-beta_</span><span class="sc">${</span>version<span class="sc">}</span><span class="st">&quot;</span><span class="op">;</span></span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a>            <span class="va">value</span> <span class="op">=</span> select version comps<span class="op">;</span></span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a>          <span class="op">})</span> rust<span class="op">-</span>bin.beta<span class="op">;</span></span>
<span id="cb21-94"><a href="#cb21-94" aria-hidden="true" tabindex="-1"></a>        <span class="va">result'</span> <span class="op">=</span> <span class="va">rust-bin</span><span class="op">:</span> filterAttrs <span class="op">(</span><span class="va">name</span><span class="op">:</span> <span class="va">drv</span><span class="op">:</span> drv <span class="op">!</span>= <span class="cn">null</span><span class="op">)</span> <span class="op">(</span>result rust<span class="op">-</span>bin<span class="op">);</span></span>
<span id="cb21-95"><a href="#cb21-95" aria-hidden="true" tabindex="-1"></a>      <span class="kw">in</span></span>
<span id="cb21-96"><a href="#cb21-96" aria-hidden="true" tabindex="-1"></a>      forEachSystem <span class="op">(</span><span class="va">system</span><span class="op">:</span></span>
<span id="cb21-97"><a href="#cb21-97" aria-hidden="true" tabindex="-1"></a>        result' <span class="op">(</span>mkRustBin <span class="op">{}</span> nixpkgs.legacyPackages.$<span class="op">{</span><span class="va">system</span><span class="op">})</span></span>
<span id="cb21-98"><a href="#cb21-98" aria-hidden="true" tabindex="-1"></a>        <span class="op">//</span> <span class="op">{</span> <span class="va">default</span> <span class="op">=</span> self.packages.$<span class="op">{</span><span class="va">system</span><span class="op">}</span>.rust<span class="op">;</span> <span class="op">}</span></span>
<span id="cb21-99"><a href="#cb21-99" aria-hidden="true" tabindex="-1"></a>      <span class="op">);</span></span>
<span id="cb21-100"><a href="#cb21-100" aria-hidden="true" tabindex="-1"></a>      <span class="co"># todo: legacyPackage가 구버전 패키지를 뜻한다는데,</span></span>
<span id="cb21-101"><a href="#cb21-101" aria-hidden="true" tabindex="-1"></a>      <span class="co"># 신버전은 뭐고, 구버전은 뭐지?</span></span>
<span id="cb21-102"><a href="#cb21-102" aria-hidden="true" tabindex="-1"></a>    <span class="va">checks</span> <span class="op">=</span> forEachSystem <span class="op">(</span><span class="bu">import</span> <span class="ss">./tests</span> inputs<span class="op">);</span></span>
<span id="cb21-103"><a href="#cb21-103" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb21-104"><a href="#cb21-104" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="genattrs-함수">genAttrs 함수</h3>
<p><code>lib.genAttrs :: [String] -&gt; (String -&gt; a) -&gt; {String = a}</code></p>
<div class="sourceCode" id="cb22"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>lib.genAttrs <span class="op">[</span> <span class="st">&quot;x86_64-linux&quot;</span> <span class="st">&quot;aarch64-darwin&quot;</span> <span class="op">]</span> <span class="op">(</span><span class="va">system</span><span class="op">:</span> <span class="st">&quot;Hello, </span><span class="sc">${</span>system<span class="sc">}</span><span class="st">!&quot;</span><span class="op">)</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co">#                                                           함수 </span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 아래와 같습니다. </span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;</span>x86_64-linux<span class="st">&quot;</span> <span class="op">=</span> <span class="st">&quot;Hello, x86_64-linux!&quot;</span><span class="op">;</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aarch64-darwin&quot;</span> <span class="op">=</span> <span class="st">&quot;Hello, aarch64-darwin!&quot;</span><span class="op">;</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="filterattrs-함수">filterAttrs 함수</h3>
<p>속성 필터</p>
<h3 id="mapattrs-함수">mapAttrs’ 함수</h3>
<p>속성 매핑</p>
<h3 id="replacestrings-함수">replaceStrings 함수</h3>
<p>문자열 치환</p>
<h2 id="flake-utils">flake-utils</h2>
<p>지루한 플랫폼별 attrset을 대신 해주는 라이브러리를 가지고 있다.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">inputs</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">nixpkgs</span>.<span class="va">url</span> <span class="op">=</span> <span class="st">&quot;github:nixos/nixpkgs&quot;</span><span class="op">;</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">flake-utils</span>.<span class="va">url</span> <span class="op">=</span> <span class="st">&quot;github:numtide/flake-utils&quot;</span><span class="op">;</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="va">outputs</span> <span class="op">=</span> <span class="op">{</span> <span class="va">self</span><span class="op">,</span> <span class="va">nixpkgs</span><span class="op">,</span> <span class="va">flake-utils</span> <span class="op">}</span>:</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    flake<span class="op">-</span>utils.lib.eachDefaultSystem <span class="op">(</span><span class="va">system</span><span class="op">:</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> <span class="va">pkgs</span> <span class="op">=</span> nixpkgs.legacyPackages.$<span class="op">{</span><span class="va">system</span><span class="op">};</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>      <span class="kw">in</span> <span class="op">{</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">packages</span>.<span class="va">hello</span> <span class="op">=</span> pkgs.hello<span class="op">;</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">devShell</span> <span class="op">=</span> pkgs.mkShell <span class="op">{</span> <span class="va">buildInputs</span> <span class="op">=</span> <span class="op">[</span> pkgs.hello pkgs.cowsay <span class="op">];</span> <span class="op">};</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>      <span class="op">});</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="flake-parts">Flake parts</h3>
<p><a href="https://flake.parts/">Flake Parts</a><br />
Flake를 작성할 때, <code>flake.nix</code> 파일에 여러 필드를 정의하는데, Flake Parts를 이용하면, 기능을 모듈화하여 쉽게 조합하고 관리할 수 있다. 기존 Flake는 <code>flake.nix</code>에 <code>packages</code>, <code>devShells</code>, <code>checks</code> 등을 모두 직접 정의해야 하는데, 이를 모듈화 할 수 있다.</p>
<p>Flake Parts는 모듈화 구조로 표현할 수 있게 도와주는 여러 함수들의 모음입니다.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">description</span> <span class="op">=</span> <span class="st">&quot;My Flake using Flake Parts&quot;</span><span class="op">;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">inputs</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">nixpkgs</span>.<span class="va">url</span> <span class="op">=</span> <span class="st">&quot;github:NixOS/nixpkgs&quot;</span><span class="op">;</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">flake-parts</span>.<span class="va">url</span> <span class="op">=</span> <span class="st">&quot;github:hercules-ci/flake-parts&quot;</span><span class="op">;</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  <span class="va">outputs</span> <span class="op">=</span> inputs@<span class="op">{</span> <span class="va">self</span><span class="op">,</span> <span class="va">nixpkgs</span><span class="op">,</span> <span class="va">flake-parts</span><span class="op">,</span> <span class="op">...</span> <span class="op">}</span>:</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    flake<span class="op">-</span>parts.lib.mkFlake <span class="op">{</span> <span class="kw">inherit</span> inputs<span class="op">;</span> <span class="op">}</span> <span class="op">{</span> <span class="co"># &lt;---------</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>      <span class="va">systems</span> <span class="op">=</span> <span class="op">[</span> <span class="st">&quot;x86_64-linux&quot;</span> <span class="st">&quot;aarch64-linux&quot;</span> <span class="op">];</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>      <span class="va">perSystem</span> <span class="op">=</span> <span class="op">{</span> <span class="va">pkgs</span><span class="op">,</span> <span class="op">...</span> <span class="op">}</span>: <span class="op">{</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">packages</span>.<span class="va">hello</span> <span class="op">=</span> pkgs.hello<span class="op">;</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">devShells</span>.<span class="va">default</span> <span class="op">=</span> pkgs.mkShell <span class="op">{</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>          <span class="va">buildInputs</span> <span class="op">=</span> <span class="op">[</span> pkgs.hello <span class="op">];</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>      <span class="op">};</span></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="flake-y-닉스와-non-flake-닉스-비교">Flake-y 닉스와 Non-Flake 닉스 비교</h2>
<h3 id="non-flake-닉스">Non-Flake 닉스</h3>
<p><code>default.nix</code></p>
<div class="sourceCode" id="cb25"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">pkgs</span> <span class="op">?</span> <span class="bu">import</span> &lt;nixpkgs&gt; <span class="op">{}</span> <span class="op">}</span>:</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>pkgs.haskellPackages.callCabal2nix <span class="st">&quot;my-haskell-project&quot;</span> . <span class="op">{}</span></span></code></pre></div>
<p><code>shell.nix</code></p>
<div class="sourceCode" id="cb26"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">pkgs</span> <span class="op">?</span> <span class="bu">import</span> &lt;nixpkgs&gt; <span class="op">{}</span> <span class="op">}</span>:</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>pkgs.mkShell <span class="op">{</span> <span class="co"># 개발 환경 정의</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">buildInputs</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    pkgs.haskell.compiler.ghc962</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    pkgs.haskellPackages.cabal-install</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">];</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>default.nix</code>는 패키지 빌드 역할을 하고, <code>shell.nix</code>는 <code>nix-shell</code>이 개발 환경을 불러올 때 쓰인다.</p>
<h3 id="flake-y-닉스">Flake-y 닉스</h3>
<p><code>flake.nix</code></p>
<div class="sourceCode" id="cb27"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">description</span> <span class="op">=</span> <span class="st">&quot;My Haskell project with Nix flakes&quot;</span><span class="op">;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">inputs</span> <span class="op">=</span> <span class="op">{</span> <span class="va">nixpkgs</span>.<span class="va">url</span> <span class="op">=</span> <span class="st">&quot;github:NixOS/nixpkgs/nixos-unstable&quot;</span><span class="op">;</span> <span class="op">};</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="va">outputs</span> <span class="op">=</span> <span class="op">{</span> <span class="va">self</span><span class="op">,</span> <span class="va">nixpkgs</span> <span class="op">}</span>: </span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">system</span> <span class="op">=</span> <span class="st">&quot;x86_64-linux&quot;</span><span class="op">;</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="va">pkgs</span> <span class="op">=</span> <span class="bu">import</span> nixpkgs <span class="op">{</span> <span class="kw">inherit</span> system<span class="op">;</span> <span class="op">};</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">in</span> <span class="op">{</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="va">packages</span>.${<span class="va">system</span><span class="op">}</span>.default = pkgs.haskellPackages.callCabal2nix <span class="st">&quot;my-haskell-project&quot;</span> . <span class="op">{};</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    <span class="va">devShells</span>.${<span class="va">system</span><span class="op">}</span>.default = pkgs.mkShell <span class="op">{</span> <span class="co"># 개발 환경 정의</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>      <span class="va">buildInputs</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>        pkgs.haskell.compiler.ghc962</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>        pkgs.haskellPackages.cabal-install</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>      <span class="op">];</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>;</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>  };</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><code>flake.nix</code> 하나로 패키지 빌드와 환경 설정을 모두 해결하고, <code>nix-shell</code> 대신 <code>nix develop</code>으로 개발 환경에 진입합니다. <code>nix build</code>, <code>nix run</code>으로 빌드하고 실행합니다. <code>nixos-unstable</code>로 명확히 채널을 지정하고 있습니다.</p>
<p>Flake는 새로운 방식으로 스펙을 정의하는 속성attribute 파일을 해석하는 인터프리터를, 닉스 패키지 매니저 시스템에 추가한 것으로 볼 수 있겠습니다. 명확하게 <code>inputs</code>에 외부 의존성을 두고, <code>outputs</code>가 <code>nix build</code>, <code>nix develop</code>과 연결된다고 볼 수 있습니다.</p>
<table>
<thead>
<tr>
<th>classic</th>
<th>flake-y</th>
<th>동작</th>
</tr>
</thead>
<tbody>
<tr>
<td>nix-build</td>
<td><strong>nix build</strong></td>
<td>빌드</td>
</tr>
<tr>
<td>nix-shell</td>
<td><strong>nix develop</strong></td>
<td>개발 환경 열기</td>
</tr>
<tr>
<td>nix-env</td>
<td><strong>nix profile</strong></td>
<td>개인 계정에 패키지 추가</td>
</tr>
<tr>
<td>nix-collect-garbage</td>
<td><strong>nix flake prune</strong></td>
<td>사용하지 않는 패키지 삭제</td>
</tr>
<tr>
<td>nix-store</td>
<td><strong>nix flake show</strong></td>
<td></td>
</tr>
<tr>
<td>nix-repl</td>
<td><strong>nix eval</strong></td>
<td></td>
</tr>
<tr>
<td>nix run</td>
<td><strong>nix run</strong></td>
<td></td>
</tr>
<tr>
<td>nix-channel</td>
<td><strong>nix flake update</strong></td>
<td></td>
</tr>
</tbody>
</table>
<p>Non-Flake 닉스에선 <code>buildPhase</code>, <code>configurePhase</code>, <code>installPhase</code> 등으로 빌드 과정을 제어했습니다.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">stdenv</span><span class="op">,</span> <span class="va">fetchurl</span> <span class="op">}</span>:</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>stdenv.mkDerivation <span class="kw">rec</span> <span class="op">{</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">name</span> <span class="op">=</span> <span class="st">&quot;example-1.0&quot;</span><span class="op">;</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">src</span> <span class="op">=</span> fetchurl <span class="op">{</span> <span class="va">url</span> <span class="op">=</span> <span class="st">&quot;http://example.com/example-1.0.tar.gz&quot;</span><span class="op">;</span> <span class="op">};</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="va">buildPhase</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="st">    echo &quot;Building...&quot;</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="st">    # Custom build commands</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="st">  ''</span><span class="op">;</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  <span class="va">configurePhase</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="st">    echo &quot;Configuring...&quot;</span></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="st">    # Custom configuration commands</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="st">  ''</span><span class="op">;</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>  <span class="va">installPhase</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="st">    echo &quot;Installing...&quot;</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a><span class="st">    # Custom install commands</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a><span class="st">  ''</span><span class="op">;</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Flake-y에서도 위 정의들을 <code>mkDerivation</code> 안에서 그대로 정의할 수 있습니다.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">description</span> <span class="op">=</span> <span class="st">&quot;My Haskell project&quot;</span><span class="op">;</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">inputs</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="va">nixpkgs</span>.<span class="va">url</span> <span class="op">=</span> <span class="st">&quot;github:NixOS/nixpkgs/nixos-unstable&quot;</span><span class="op">;</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="va">outputs</span> <span class="op">=</span> <span class="op">{</span> <span class="va">self</span><span class="op">,</span> <span class="va">nixpkgs</span> <span class="op">}</span>:</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="va">system</span> <span class="op">=</span> <span class="st">&quot;x86_64-linux&quot;</span><span class="op">;</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    <span class="va">pkgs</span> <span class="op">=</span> <span class="bu">import</span> nixpkgs <span class="op">{</span> <span class="kw">inherit</span> system<span class="op">;</span> <span class="op">};</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">in</span> <span class="op">{</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    <span class="va">packages</span>.${<span class="va">system</span><span class="op">}</span>.default = pkgs.stdenv.mkDerivation <span class="op">{</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>      <span class="va">name</span> <span class="op">=</span> <span class="st">&quot;example-1.0&quot;</span><span class="op">;</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>      <span class="va">src</span> <span class="op">=</span> <span class="ss">./src</span><span class="op">;</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>      <span class="va">buildPhase</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="st">        echo &quot;Building...&quot;</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="st">        # Custom build commands here</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a><span class="st">      ''</span><span class="op">;</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>      <span class="va">configurePhase</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a><span class="st">        echo &quot;Configuring...&quot;</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a><span class="st">        # Custom configuration commands here</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a><span class="st">      ''</span><span class="op">;</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>      <span class="va">installPhase</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a><span class="st">        echo &quot;Installing...&quot;</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a><span class="st">        # Custom install commands here</span></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a><span class="st">      ''</span><span class="op">;</span></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>;</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 id="초간단-flake-y-닉스-모형-코드">초간단 Flake-y 닉스 모형 코드</h2>
<div class="sourceCode" id="cb30"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE RecordWildCards #-}</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">System.Directory</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">System.Process</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">System.IO</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.Map</span> (<span class="dt">Map</span>, empty, insert, lookup, fromList, (!))</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.Hashable</span> (hash)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.ByteString.Char8</span> (pack, unpack)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Crypto.Hash</span> (<span class="dt">Digest</span>, <span class="dt">SHA256</span>, hashlazy)</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Text.Printf</span> (printf)</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Derivation</span> <span class="ot">=</span> <span class="dt">Derivation</span> {</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="ot">  name ::</span> <span class="dt">String</span>,</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="ot">  source ::</span> <span class="dt">String</span>,</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="ot">  buildInputs ::</span> [<span class="dt">Derivation</span>], </span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="ot">  buildFunc ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> [<span class="dt">FilePath</span>] <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">FilePath</span>,</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a><span class="ot">  outputPath ::</span> <span class="dt">Maybe</span> <span class="dt">FilePath</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">NixStore</span> <span class="ot">=</span> <span class="dt">NixStore</span> {</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a><span class="ot">  store ::</span> <span class="dt">Map</span> <span class="dt">String</span> <span class="dt">FilePath</span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">FlakeInput</span> <span class="ot">=</span> <span class="dt">FlakeInput</span> {</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a><span class="ot">  inputName ::</span> <span class="dt">String</span>,</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a><span class="ot">  inputSource ::</span> <span class="dt">String</span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Flake</span> <span class="ot">=</span> <span class="dt">Flake</span> {</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a><span class="ot">  inputs ::</span> [<span class="dt">FlakeInput</span>],</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a><span class="ot">  outputs ::</span> <span class="dt">Map</span> <span class="dt">String</span> <span class="dt">Derivation</span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a><span class="co">-- 해시 함수 (단순화를 위해 name과 buildInputs만 사용)</span></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a><span class="ot">hashDerivation ::</span> <span class="dt">Derivation</span> <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>hashDerivation <span class="dt">Derivation</span>{<span class="op">..</span>} <span class="ot">=</span> printf <span class="st">&quot;%x&quot;</span> (hash (name, <span class="fu">map</span> name buildInputs)<span class="ot"> ::</span> <span class="dt">Int</span>)</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a><span class="ot">build ::</span> <span class="dt">NixStore</span> <span class="ot">-&gt;</span> <span class="dt">Derivation</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">NixStore</span></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>build nixStore derivation <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> hashedName <span class="ot">=</span> hashDerivation derivation</span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>  <span class="kw">case</span> Data.Map.lookup hashedName (store nixStore) <span class="kw">of</span></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Just</span> path <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>      <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;Using cached build for &quot;</span> <span class="op">++</span> name derivation <span class="op">++</span> <span class="st">&quot; at &quot;</span> <span class="op">++</span> path</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span> <span class="dt">NixStore</span> { store <span class="ot">=</span> Data.Map.insert hashedName path (store nixStore) }</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;Building &quot;</span> <span class="op">++</span> name derivation <span class="op">++</span> <span class="st">&quot;...&quot;</span></span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>      buildInputsPath <span class="ot">&lt;-</span> <span class="fu">mapM</span> (\dep <span class="ot">-&gt;</span> <span class="kw">case</span> outputPath dep <span class="kw">of</span></span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Just</span> path <span class="ot">-&gt;</span> <span class="fu">return</span> path</span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a>          nixStore' <span class="ot">&lt;-</span> build nixStore dep</span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a>          <span class="kw">case</span> Data.Map.lookup (hashDerivation dep) (store nixStore') <span class="kw">of</span></span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Just</span> path <span class="ot">-&gt;</span> <span class="fu">return</span> path</span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="op">$</span> <span class="st">&quot;Dependency &quot;</span> <span class="op">++</span> name dep <span class="op">++</span> <span class="st">&quot; not found in store&quot;</span></span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a>        ) (buildInputs derivation)</span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> buildDir <span class="ot">=</span> <span class="st">&quot;store/&quot;</span> <span class="op">++</span> hashedName</span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a>      createDirectoryIfMissing <span class="dt">True</span> buildDir</span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a>      outputPath' <span class="ot">&lt;-</span> (buildFunc derivation) buildDir buildInputsPath</span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> store' <span class="ot">=</span> Data.Map.insert hashedName outputPath' (store nixStore)</span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a>      <span class="fu">putStrLn</span> <span class="op">$</span> name derivation <span class="op">++</span> <span class="st">&quot; built at &quot;</span> <span class="op">++</span> outputPath'</span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span> <span class="dt">NixStore</span> { store <span class="ot">=</span> store' }</span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a><span class="ot">runNix ::</span> <span class="dt">NixStore</span> <span class="ot">-&gt;</span> <span class="dt">Derivation</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a>runNix nixStore derivation <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a>  nixStore' <span class="ot">&lt;-</span> build nixStore derivation</span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a>  <span class="kw">case</span> Data.Map.lookup (hashDerivation derivation) (store nixStore') <span class="kw">of</span></span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Just</span> path <span class="ot">-&gt;</span> <span class="fu">putStrLn</span> <span class="op">$</span> name derivation <span class="op">++</span> <span class="st">&quot;: &quot;</span> <span class="op">++</span> path</span>
<span id="cb30-71"><a href="#cb30-71" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="op">$</span> <span class="st">&quot;Derivation &quot;</span> <span class="op">++</span> name derivation <span class="op">++</span> <span class="st">&quot;not found in store&quot;</span></span>
<span id="cb30-72"><a href="#cb30-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-73"><a href="#cb30-73" aria-hidden="true" tabindex="-1"></a><span class="ot">buildHello ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> [<span class="dt">FilePath</span>] <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">FilePath</span></span>
<span id="cb30-74"><a href="#cb30-74" aria-hidden="true" tabindex="-1"></a>buildHello buildDir _ <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb30-75"><a href="#cb30-75" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> remote <span class="ot">=</span> <span class="st">&quot;remoteGit/hello/&quot;</span></span>
<span id="cb30-76"><a href="#cb30-76" aria-hidden="true" tabindex="-1"></a>  copyFile (remote <span class="op">++</span> <span class="st">&quot;/hello.c&quot;</span>) (buildDir <span class="op">++</span> <span class="st">&quot;/hello.c&quot;</span>)</span>
<span id="cb30-77"><a href="#cb30-77" aria-hidden="true" tabindex="-1"></a>  copyFile (remote <span class="op">++</span> <span class="st">&quot;/hello.h&quot;</span>) (buildDir <span class="op">++</span> <span class="st">&quot;/hello.h&quot;</span>)</span>
<span id="cb30-78"><a href="#cb30-78" aria-hidden="true" tabindex="-1"></a>  system <span class="op">$</span> <span class="st">&quot;gcc -c -o &quot;</span> <span class="op">++</span> buildDir <span class="op">++</span> <span class="st">&quot;/hello.o &quot;</span> <span class="op">++</span> buildDir <span class="op">++</span> <span class="st">&quot;/hello.c&quot;</span></span>
<span id="cb30-79"><a href="#cb30-79" aria-hidden="true" tabindex="-1"></a>  system <span class="op">$</span> <span class="st">&quot;ar rcs &quot;</span> <span class="op">++</span> buildDir <span class="op">++</span> <span class="st">&quot;/libhello.a &quot;</span> <span class="op">++</span> buildDir <span class="op">++</span> <span class="st">&quot;/hello.o&quot;</span></span>
<span id="cb30-80"><a href="#cb30-80" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> <span class="op">$</span> buildDir <span class="op">++</span> <span class="st">&quot;/libhello.a&quot;</span></span>
<span id="cb30-81"><a href="#cb30-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-82"><a href="#cb30-82" aria-hidden="true" tabindex="-1"></a><span class="ot">buildMorning ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> [<span class="dt">FilePath</span>] <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">FilePath</span></span>
<span id="cb30-83"><a href="#cb30-83" aria-hidden="true" tabindex="-1"></a>buildMorning buildDir [helloPath] <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb30-84"><a href="#cb30-84" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> remote <span class="ot">=</span> <span class="st">&quot;remoteGit/morning/&quot;</span></span>
<span id="cb30-85"><a href="#cb30-85" aria-hidden="true" tabindex="-1"></a>      helloOutputDir <span class="ot">=</span> <span class="fu">init</span> <span class="op">$</span> <span class="fu">reverse</span> <span class="op">$</span> <span class="fu">dropWhile</span> (<span class="op">/=</span> <span class="ch">'/'</span>) <span class="op">$</span> <span class="fu">reverse</span> helloPath</span>
<span id="cb30-86"><a href="#cb30-86" aria-hidden="true" tabindex="-1"></a>  copyFile (remote <span class="op">++</span> <span class="st">&quot;/morning.c&quot;</span>) (buildDir <span class="op">++</span> <span class="st">&quot;/morning.c&quot;</span>)</span>
<span id="cb30-87"><a href="#cb30-87" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> gcc <span class="ot">=</span> <span class="st">&quot;gcc -o &quot;</span> <span class="op">++</span> buildDir <span class="op">++</span> <span class="st">&quot;/morning &quot;</span> </span>
<span id="cb30-88"><a href="#cb30-88" aria-hidden="true" tabindex="-1"></a>                     <span class="op">++</span> buildDir <span class="op">++</span> <span class="st">&quot;/morning.c &quot;</span> </span>
<span id="cb30-89"><a href="#cb30-89" aria-hidden="true" tabindex="-1"></a>                     <span class="op">++</span> <span class="st">&quot;-L&quot;</span> <span class="op">++</span> helloOutputDir <span class="op">++</span> <span class="st">&quot; -lhello &quot;</span></span>
<span id="cb30-90"><a href="#cb30-90" aria-hidden="true" tabindex="-1"></a>                     <span class="op">++</span> <span class="st">&quot;-I&quot;</span> <span class="op">++</span> helloOutputDir</span>
<span id="cb30-91"><a href="#cb30-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">putStrLn</span> gcc</span>
<span id="cb30-92"><a href="#cb30-92" aria-hidden="true" tabindex="-1"></a>  system gcc</span>
<span id="cb30-93"><a href="#cb30-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> <span class="op">$</span> buildDir <span class="op">++</span> <span class="st">&quot;/morning&quot;</span></span>
<span id="cb30-94"><a href="#cb30-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-95"><a href="#cb30-95" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb30-96"><a href="#cb30-96" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb30-97"><a href="#cb30-97" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> helloDerivation <span class="ot">=</span> <span class="dt">Derivation</span> {</span>
<span id="cb30-98"><a href="#cb30-98" aria-hidden="true" tabindex="-1"></a>        name <span class="ot">=</span> <span class="st">&quot;hello&quot;</span>,</span>
<span id="cb30-99"><a href="#cb30-99" aria-hidden="true" tabindex="-1"></a>        source <span class="ot">=</span> <span class="st">&quot;hello.c&quot;</span>,</span>
<span id="cb30-100"><a href="#cb30-100" aria-hidden="true" tabindex="-1"></a>        buildInputs <span class="ot">=</span> [],</span>
<span id="cb30-101"><a href="#cb30-101" aria-hidden="true" tabindex="-1"></a>        buildFunc <span class="ot">=</span> buildHello,</span>
<span id="cb30-102"><a href="#cb30-102" aria-hidden="true" tabindex="-1"></a>        outputPath <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="cb30-103"><a href="#cb30-103" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb30-104"><a href="#cb30-104" aria-hidden="true" tabindex="-1"></a>      morningDerivation <span class="ot">=</span> <span class="dt">Derivation</span> {</span>
<span id="cb30-105"><a href="#cb30-105" aria-hidden="true" tabindex="-1"></a>        name <span class="ot">=</span> <span class="st">&quot;morning&quot;</span>,</span>
<span id="cb30-106"><a href="#cb30-106" aria-hidden="true" tabindex="-1"></a>        source <span class="ot">=</span> <span class="st">&quot;morning.c&quot;</span>,</span>
<span id="cb30-107"><a href="#cb30-107" aria-hidden="true" tabindex="-1"></a>        buildInputs <span class="ot">=</span> [helloDerivation],</span>
<span id="cb30-108"><a href="#cb30-108" aria-hidden="true" tabindex="-1"></a>        buildFunc <span class="ot">=</span> buildMorning,</span>
<span id="cb30-109"><a href="#cb30-109" aria-hidden="true" tabindex="-1"></a>        outputPath <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="cb30-110"><a href="#cb30-110" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb30-111"><a href="#cb30-111" aria-hidden="true" tabindex="-1"></a>      nixStore <span class="ot">=</span> <span class="dt">NixStore</span>{ store <span class="ot">=</span> empty }</span>
<span id="cb30-112"><a href="#cb30-112" aria-hidden="true" tabindex="-1"></a>      myFlake <span class="ot">=</span> <span class="dt">Flake</span> {</span>
<span id="cb30-113"><a href="#cb30-113" aria-hidden="true" tabindex="-1"></a>        inputs <span class="ot">=</span> [<span class="dt">FlakeInput</span> { inputName <span class="ot">=</span> <span class="st">&quot;hello&quot;</span>, inputSource <span class="ot">=</span> <span class="st">&quot;remoteGit/hello&quot;</span> }],</span>
<span id="cb30-114"><a href="#cb30-114" aria-hidden="true" tabindex="-1"></a>        outputs <span class="ot">=</span> fromList [(<span class="st">&quot;morning&quot;</span>, morningDerivation), (<span class="st">&quot;hello&quot;</span>, helloDerivation)]</span>
<span id="cb30-115"><a href="#cb30-115" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb30-116"><a href="#cb30-116" aria-hidden="true" tabindex="-1"></a>  runNix nixStore (outputs myFlake <span class="op">!</span> <span class="st">&quot;morning&quot;</span>)</span></code></pre></div>
<p>좀 더 복잡하게</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# LANGUAGE RecordWildCards #-}</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">System.Directory</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">System.Process</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">System.IO</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.Map</span> (<span class="dt">Map</span>, empty, insert, lookup)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Map</span> <span class="kw">as</span> <span class="dt">Map</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">System.FilePath</span> ((&lt;/&gt;))</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Derivation</span> <span class="ot">=</span> <span class="dt">Derivation</span> {</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="ot">  name ::</span> <span class="dt">String</span>,</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="ot">  source ::</span> <span class="dt">String</span>,</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="ot">  buildInputs ::</span> [<span class="dt">Derivation</span>], </span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="ot">  buildFunc ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> [<span class="dt">FilePath</span>] <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">FilePath</span>,</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="ot">  outputPath ::</span> <span class="dt">Maybe</span> <span class="dt">FilePath</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">NixStore</span> <span class="ot">=</span> <span class="dt">NixStore</span> {</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="ot">  store ::</span> <span class="dt">Map</span> <span class="dt">String</span> <span class="dt">FilePath</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Flake</span> <span class="ot">=</span> <span class="dt">Flake</span> {</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="ot">  flakeName ::</span> <span class="dt">String</span>,</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="ot">  flakeInputs ::</span> <span class="dt">Map</span> <span class="dt">String</span> <span class="dt">FlakeRef</span>,  <span class="co">-- 다른 Flake 의존성</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a><span class="ot">  flakeOutputs ::</span> <span class="dt">FlakeOutputs</span>         <span class="co">-- 이 Flake가 제공하는 것들</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a><span class="co">-- Flake 참조 (URL 또는 로컬 경로)</span></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">FlakeRef</span> <span class="ot">=</span> <span class="dt">FlakeRef</span> {</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a><span class="ot">  flakeUrl ::</span> <span class="dt">String</span>,  <span class="co">-- git URL 또는 로컬 경로</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a><span class="ot">  flakeRevision ::</span> <span class="dt">Maybe</span> <span class="dt">String</span>  <span class="co">-- git revision 또는 Nothing (최신)</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>} <span class="kw">deriving</span> (<span class="dt">Show</span>)</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a><span class="co">-- Flake 출력 모형</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">FlakeOutputs</span> <span class="ot">=</span> <span class="dt">FlakeOutputs</span> {</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a><span class="ot">  packages ::</span> <span class="dt">Map</span> <span class="dt">String</span> <span class="dt">Derivation</span>,  <span class="co">-- 패키지들 (e.g., &quot;default&quot;, &quot;dev&quot;, etc.)</span></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a><span class="ot">  devShells ::</span> <span class="dt">Map</span> <span class="dt">String</span> <span class="dt">Derivation</span>,  <span class="co">-- 개발 환경</span></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a><span class="ot">  nixosConfigurations ::</span> <span class="dt">Map</span> <span class="dt">String</span> <span class="dt">Derivation</span>  <span class="co">-- NixOS 구성</span></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a><span class="co">-- Flake Lock 모형 (의존성 버전 고정)</span></span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">FlakeLock</span> <span class="ot">=</span> <span class="dt">FlakeLock</span> {</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a><span class="ot">  lockInputs ::</span> <span class="dt">Map</span> <span class="dt">String</span> <span class="dt">LockedFlakeRef</span></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">LockedFlakeRef</span> <span class="ot">=</span> <span class="dt">LockedFlakeRef</span> {</span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a><span class="ot">  lockedUrl ::</span> <span class="dt">String</span>,</span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a><span class="ot">  lockedRevision ::</span> <span class="dt">String</span>,</span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a><span class="ot">  lockedNarHash ::</span> <span class="dt">String</span>  <span class="co">-- 내용 해시</span></span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>} <span class="kw">deriving</span> (<span class="dt">Show</span>)</span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a><span class="co">-- 기존 build 함수</span></span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a><span class="ot">build ::</span> <span class="dt">NixStore</span> <span class="ot">-&gt;</span> <span class="dt">Derivation</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">NixStore</span></span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a>build nixStore derivation <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a>  <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;Building &quot;</span> <span class="op">++</span> name derivation <span class="op">++</span> <span class="st">&quot;...&quot;</span></span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a>  buildInputsPath <span class="ot">&lt;-</span> <span class="fu">mapM</span> (\dep <span class="ot">-&gt;</span> <span class="kw">case</span> outputPath dep <span class="kw">of</span></span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Just</span> path <span class="ot">-&gt;</span> <span class="fu">return</span> path</span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="kw">do</span> <span class="co">-- 아직 빌드하지 않았다면</span></span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a>      nixStore' <span class="ot">&lt;-</span> build nixStore dep</span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a>      <span class="kw">case</span> Data.Map.lookup (name dep) (store nixStore') <span class="kw">of</span></span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Just</span> path <span class="ot">-&gt;</span> <span class="fu">return</span> path</span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="op">$</span> <span class="st">&quot;Dependency &quot;</span> <span class="op">++</span> name dep <span class="op">++</span> <span class="st">&quot; not found in store&quot;</span></span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a>    ) (buildInputs derivation)</span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> buildDir <span class="ot">=</span> <span class="st">&quot;store/&quot;</span> <span class="op">++</span> name derivation <span class="co">-- store/hello</span></span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a>  createDirectoryIfMissing <span class="dt">True</span> buildDir</span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a>  outputPath' <span class="ot">&lt;-</span> (buildFunc derivation) buildDir buildInputsPath</span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> store' <span class="ot">=</span> Data.Map.insert (name derivation) outputPath' (store nixStore)</span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">putStrLn</span> <span class="op">$</span> (name derivation) <span class="op">++</span> <span class="st">&quot; built at &quot;</span> <span class="op">++</span> outputPath'</span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> <span class="dt">NixStore</span> { store <span class="ot">=</span> store' }</span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a><span class="ot">runNix ::</span> <span class="dt">NixStore</span> <span class="ot">-&gt;</span> <span class="dt">Derivation</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb31-72"><a href="#cb31-72" aria-hidden="true" tabindex="-1"></a>runNix nixStore derivation <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb31-73"><a href="#cb31-73" aria-hidden="true" tabindex="-1"></a>  nixStore' <span class="ot">&lt;-</span> build nixStore derivation</span>
<span id="cb31-74"><a href="#cb31-74" aria-hidden="true" tabindex="-1"></a>  <span class="kw">case</span> Data.Map.lookup (name derivation) (store nixStore') <span class="kw">of</span></span>
<span id="cb31-75"><a href="#cb31-75" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Just</span> path <span class="ot">-&gt;</span> <span class="fu">putStrLn</span> <span class="op">$</span> name derivation <span class="op">++</span> <span class="st">&quot;: &quot;</span> <span class="op">++</span> path</span>
<span id="cb31-76"><a href="#cb31-76" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="op">$</span> <span class="st">&quot;Derivation &quot;</span> <span class="op">++</span> name derivation <span class="op">++</span> <span class="st">&quot;not found in store&quot;</span></span>
<span id="cb31-77"><a href="#cb31-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-78"><a href="#cb31-78" aria-hidden="true" tabindex="-1"></a><span class="co">-- Flake 관련 함수들</span></span>
<span id="cb31-79"><a href="#cb31-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-80"><a href="#cb31-80" aria-hidden="true" tabindex="-1"></a><span class="co">-- Flake 평가 (flake.nix 파일을 읽고 파싱하는 과정 모형화)</span></span>
<span id="cb31-81"><a href="#cb31-81" aria-hidden="true" tabindex="-1"></a><span class="ot">evaluateFlake ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">Flake</span></span>
<span id="cb31-82"><a href="#cb31-82" aria-hidden="true" tabindex="-1"></a>evaluateFlake flakePath <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb31-83"><a href="#cb31-83" aria-hidden="true" tabindex="-1"></a>  <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;Evaluating flake at &quot;</span> <span class="op">++</span> flakePath</span>
<span id="cb31-84"><a href="#cb31-84" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- 실제로는 flake.nix 파일을 파싱하고 평가해야 함</span></span>
<span id="cb31-85"><a href="#cb31-85" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- 여기서는 간단한 예제 flake를 반환</span></span>
<span id="cb31-86"><a href="#cb31-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> <span class="op">$</span> <span class="dt">Flake</span> {</span>
<span id="cb31-87"><a href="#cb31-87" aria-hidden="true" tabindex="-1"></a>    flakeName <span class="ot">=</span> <span class="st">&quot;example&quot;</span>,</span>
<span id="cb31-88"><a href="#cb31-88" aria-hidden="true" tabindex="-1"></a>    flakeInputs <span class="ot">=</span> Map.fromList [</span>
<span id="cb31-89"><a href="#cb31-89" aria-hidden="true" tabindex="-1"></a>      (<span class="st">&quot;nixpkgs&quot;</span>, <span class="dt">FlakeRef</span> {</span>
<span id="cb31-90"><a href="#cb31-90" aria-hidden="true" tabindex="-1"></a>        flakeUrl <span class="ot">=</span> <span class="st">&quot;github:NixOS/nixpkgs&quot;</span>,</span>
<span id="cb31-91"><a href="#cb31-91" aria-hidden="true" tabindex="-1"></a>        flakeRevision <span class="ot">=</span> <span class="dt">Just</span> <span class="st">&quot;nixos-22.05&quot;</span></span>
<span id="cb31-92"><a href="#cb31-92" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb31-93"><a href="#cb31-93" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb31-94"><a href="#cb31-94" aria-hidden="true" tabindex="-1"></a>    flakeOutputs <span class="ot">=</span> <span class="dt">FlakeOutputs</span> {</span>
<span id="cb31-95"><a href="#cb31-95" aria-hidden="true" tabindex="-1"></a>      packages <span class="ot">=</span> Map.fromList [</span>
<span id="cb31-96"><a href="#cb31-96" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&quot;default&quot;</span>, helloDerivation),</span>
<span id="cb31-97"><a href="#cb31-97" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&quot;morning&quot;</span>, morningDerivation)</span>
<span id="cb31-98"><a href="#cb31-98" aria-hidden="true" tabindex="-1"></a>      ],</span>
<span id="cb31-99"><a href="#cb31-99" aria-hidden="true" tabindex="-1"></a>      devShells <span class="ot">=</span> Map.fromList [</span>
<span id="cb31-100"><a href="#cb31-100" aria-hidden="true" tabindex="-1"></a>        (<span class="st">&quot;default&quot;</span>, devShellDerivation)</span>
<span id="cb31-101"><a href="#cb31-101" aria-hidden="true" tabindex="-1"></a>      ],</span>
<span id="cb31-102"><a href="#cb31-102" aria-hidden="true" tabindex="-1"></a>      nixosConfigurations <span class="ot">=</span> Map.empty</span>
<span id="cb31-103"><a href="#cb31-103" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb31-104"><a href="#cb31-104" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-105"><a href="#cb31-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-106"><a href="#cb31-106" aria-hidden="true" tabindex="-1"></a><span class="co">-- Flake Lock 생성/읽기 (의존성 버전 고정)</span></span>
<span id="cb31-107"><a href="#cb31-107" aria-hidden="true" tabindex="-1"></a><span class="ot">readOrCreateLock ::</span> <span class="dt">Flake</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">FlakeLock</span></span>
<span id="cb31-108"><a href="#cb31-108" aria-hidden="true" tabindex="-1"></a>readOrCreateLock flake <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb31-109"><a href="#cb31-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">putStrLn</span> <span class="st">&quot;Reading/creating flake.lock...&quot;</span></span>
<span id="cb31-110"><a href="#cb31-110" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- 실제로는 flake.lock 파일을 읽거나 생성</span></span>
<span id="cb31-111"><a href="#cb31-111" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> <span class="op">$</span> <span class="dt">FlakeLock</span> {</span>
<span id="cb31-112"><a href="#cb31-112" aria-hidden="true" tabindex="-1"></a>    lockInputs <span class="ot">=</span> Map.fromList [</span>
<span id="cb31-113"><a href="#cb31-113" aria-hidden="true" tabindex="-1"></a>      (<span class="st">&quot;nixpkgs&quot;</span>, <span class="dt">LockedFlakeRef</span> {</span>
<span id="cb31-114"><a href="#cb31-114" aria-hidden="true" tabindex="-1"></a>        lockedUrl <span class="ot">=</span> <span class="st">&quot;github:NixOS/nixpkgs&quot;</span>,</span>
<span id="cb31-115"><a href="#cb31-115" aria-hidden="true" tabindex="-1"></a>        lockedRevision <span class="ot">=</span> <span class="st">&quot;e8039594435c68eb4f780f3e9bf3dfa1e702dc54&quot;</span>,</span>
<span id="cb31-116"><a href="#cb31-116" aria-hidden="true" tabindex="-1"></a>        lockedNarHash <span class="ot">=</span> <span class="st">&quot;sha256:1234abcd...&quot;</span></span>
<span id="cb31-117"><a href="#cb31-117" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb31-118"><a href="#cb31-118" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb31-119"><a href="#cb31-119" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb31-120"><a href="#cb31-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-121"><a href="#cb31-121" aria-hidden="true" tabindex="-1"></a><span class="co">-- Flake 명령어 실행 (nix run, nix build 등의 단순 모형)</span></span>
<span id="cb31-122"><a href="#cb31-122" aria-hidden="true" tabindex="-1"></a><span class="ot">runFlakeCommand ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb31-123"><a href="#cb31-123" aria-hidden="true" tabindex="-1"></a>runFlakeCommand command flakePath target <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb31-124"><a href="#cb31-124" aria-hidden="true" tabindex="-1"></a>  flake <span class="ot">&lt;-</span> evaluateFlake flakePath</span>
<span id="cb31-125"><a href="#cb31-125" aria-hidden="true" tabindex="-1"></a>  lock <span class="ot">&lt;-</span> readOrCreateLock flake</span>
<span id="cb31-126"><a href="#cb31-126" aria-hidden="true" tabindex="-1"></a>  <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;Executing: nix &quot;</span> <span class="op">++</span> command <span class="op">++</span> <span class="st">&quot; &quot;</span> <span class="op">++</span> flakePath <span class="op">++</span> <span class="st">&quot;#&quot;</span> <span class="op">++</span> target</span>
<span id="cb31-127"><a href="#cb31-127" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-128"><a href="#cb31-128" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- 명령어에 따라 다른 동작 수행</span></span>
<span id="cb31-129"><a href="#cb31-129" aria-hidden="true" tabindex="-1"></a>  <span class="kw">case</span> command <span class="kw">of</span></span>
<span id="cb31-130"><a href="#cb31-130" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;build&quot;</span> <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb31-131"><a href="#cb31-131" aria-hidden="true" tabindex="-1"></a>      <span class="kw">case</span> Map.lookup target (packages <span class="op">$</span> flakeOutputs flake) <span class="kw">of</span></span>
<span id="cb31-132"><a href="#cb31-132" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Just</span> drv <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb31-133"><a href="#cb31-133" aria-hidden="true" tabindex="-1"></a>          <span class="kw">let</span> nixStore <span class="ot">=</span> <span class="dt">NixStore</span>{ store <span class="ot">=</span> Map.empty }</span>
<span id="cb31-134"><a href="#cb31-134" aria-hidden="true" tabindex="-1"></a>          runNix nixStore drv</span>
<span id="cb31-135"><a href="#cb31-135" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="op">$</span> <span class="st">&quot;Package &quot;</span> <span class="op">++</span> target <span class="op">++</span> <span class="st">&quot; not found in flake&quot;</span></span>
<span id="cb31-136"><a href="#cb31-136" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-137"><a href="#cb31-137" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;run&quot;</span> <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb31-138"><a href="#cb31-138" aria-hidden="true" tabindex="-1"></a>      <span class="kw">case</span> Map.lookup target (packages <span class="op">$</span> flakeOutputs flake) <span class="kw">of</span></span>
<span id="cb31-139"><a href="#cb31-139" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Just</span> drv <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb31-140"><a href="#cb31-140" aria-hidden="true" tabindex="-1"></a>          <span class="kw">let</span> nixStore <span class="ot">=</span> <span class="dt">NixStore</span>{ store <span class="ot">=</span> Map.empty }</span>
<span id="cb31-141"><a href="#cb31-141" aria-hidden="true" tabindex="-1"></a>          nixStore' <span class="ot">&lt;-</span> build nixStore drv</span>
<span id="cb31-142"><a href="#cb31-142" aria-hidden="true" tabindex="-1"></a>          <span class="kw">case</span> Map.lookup (name drv) (store nixStore') <span class="kw">of</span></span>
<span id="cb31-143"><a href="#cb31-143" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Just</span> path <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb31-144"><a href="#cb31-144" aria-hidden="true" tabindex="-1"></a>              <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;Running &quot;</span> <span class="op">++</span> path</span>
<span id="cb31-145"><a href="#cb31-145" aria-hidden="true" tabindex="-1"></a>              system path</span>
<span id="cb31-146"><a href="#cb31-146" aria-hidden="true" tabindex="-1"></a>              <span class="fu">return</span> ()</span>
<span id="cb31-147"><a href="#cb31-147" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="st">&quot;Build failed&quot;</span></span>
<span id="cb31-148"><a href="#cb31-148" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="op">$</span> <span class="st">&quot;Package &quot;</span> <span class="op">++</span> target <span class="op">++</span> <span class="st">&quot; not found in flake&quot;</span></span>
<span id="cb31-149"><a href="#cb31-149" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-150"><a href="#cb31-150" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;develop&quot;</span> <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb31-151"><a href="#cb31-151" aria-hidden="true" tabindex="-1"></a>      <span class="kw">case</span> Map.lookup target (devShells <span class="op">$</span> flakeOutputs flake) <span class="kw">of</span></span>
<span id="cb31-152"><a href="#cb31-152" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Just</span> drv <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb31-153"><a href="#cb31-153" aria-hidden="true" tabindex="-1"></a>          <span class="kw">let</span> nixStore <span class="ot">=</span> <span class="dt">NixStore</span>{ store <span class="ot">=</span> Map.empty }</span>
<span id="cb31-154"><a href="#cb31-154" aria-hidden="true" tabindex="-1"></a>          nixStore' <span class="ot">&lt;-</span> build nixStore drv</span>
<span id="cb31-155"><a href="#cb31-155" aria-hidden="true" tabindex="-1"></a>          <span class="kw">case</span> Map.lookup (name drv) (store nixStore') <span class="kw">of</span></span>
<span id="cb31-156"><a href="#cb31-156" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Just</span> path <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb31-157"><a href="#cb31-157" aria-hidden="true" tabindex="-1"></a>              <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;Entering development shell &quot;</span> <span class="op">++</span> path</span>
<span id="cb31-158"><a href="#cb31-158" aria-hidden="true" tabindex="-1"></a>              <span class="co">-- 실제로는 새 셸 환경을 시작해야 함</span></span>
<span id="cb31-159"><a href="#cb31-159" aria-hidden="true" tabindex="-1"></a>              <span class="fu">return</span> ()</span>
<span id="cb31-160"><a href="#cb31-160" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="st">&quot;Build failed&quot;</span></span>
<span id="cb31-161"><a href="#cb31-161" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="op">$</span> <span class="st">&quot;Development shell &quot;</span> <span class="op">++</span> target <span class="op">++</span> <span class="st">&quot; not found in flake&quot;</span></span>
<span id="cb31-162"><a href="#cb31-162" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-163"><a href="#cb31-163" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">-&gt;</span> <span class="fu">error</span> <span class="op">$</span> <span class="st">&quot;Unknown command: &quot;</span> <span class="op">++</span> command</span>
<span id="cb31-164"><a href="#cb31-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-165"><a href="#cb31-165" aria-hidden="true" tabindex="-1"></a><span class="co">-- 기존 빌드 함수들</span></span>
<span id="cb31-166"><a href="#cb31-166" aria-hidden="true" tabindex="-1"></a><span class="ot">buildHello ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> [<span class="dt">FilePath</span>] <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">FilePath</span></span>
<span id="cb31-167"><a href="#cb31-167" aria-hidden="true" tabindex="-1"></a>buildHello buildDir _ <span class="ot">=</span> <span class="kw">do</span> <span class="co">-- 어딘가에서 소스를 가져오는 것을 모형화</span></span>
<span id="cb31-168"><a href="#cb31-168" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> remote <span class="ot">=</span> <span class="st">&quot;remoteGit/hello/&quot;</span></span>
<span id="cb31-169"><a href="#cb31-169" aria-hidden="true" tabindex="-1"></a>  copyFile (remote <span class="op">++</span> <span class="st">&quot;/hello.c&quot;</span>) (buildDir <span class="op">++</span> <span class="st">&quot;/hello.c&quot;</span>)</span>
<span id="cb31-170"><a href="#cb31-170" aria-hidden="true" tabindex="-1"></a>  copyFile (remote <span class="op">++</span> <span class="st">&quot;/hello.h&quot;</span>) (buildDir <span class="op">++</span> <span class="st">&quot;/hello.h&quot;</span>)</span>
<span id="cb31-171"><a href="#cb31-171" aria-hidden="true" tabindex="-1"></a>  system <span class="op">$</span> <span class="st">&quot;gcc -c -o &quot;</span> <span class="op">++</span> buildDir <span class="op">++</span> <span class="st">&quot;/hello.o &quot;</span> <span class="op">++</span> buildDir <span class="op">++</span> <span class="st">&quot;/hello.c&quot;</span></span>
<span id="cb31-172"><a href="#cb31-172" aria-hidden="true" tabindex="-1"></a>  system <span class="op">$</span> <span class="st">&quot;ar rcs &quot;</span> <span class="op">++</span> buildDir <span class="op">++</span> <span class="st">&quot;/libhello.a &quot;</span> <span class="op">++</span> buildDir <span class="op">++</span> <span class="st">&quot;/hello.o&quot;</span></span>
<span id="cb31-173"><a href="#cb31-173" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> <span class="op">$</span> buildDir <span class="op">++</span> <span class="st">&quot;/libhello.a&quot;</span></span>
<span id="cb31-174"><a href="#cb31-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-175"><a href="#cb31-175" aria-hidden="true" tabindex="-1"></a><span class="ot">buildMorning ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> [<span class="dt">FilePath</span>] <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">FilePath</span></span>
<span id="cb31-176"><a href="#cb31-176" aria-hidden="true" tabindex="-1"></a>buildMorning buildDir [helloPath] <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb31-177"><a href="#cb31-177" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> remote <span class="ot">=</span> <span class="st">&quot;remoteGit/morning/&quot;</span></span>
<span id="cb31-178"><a href="#cb31-178" aria-hidden="true" tabindex="-1"></a>      helloOutputDir <span class="ot">=</span> <span class="fu">init</span> <span class="op">$</span> <span class="fu">reverse</span> <span class="op">$</span> <span class="fu">dropWhile</span> (<span class="op">/=</span> <span class="ch">'/'</span>) <span class="op">$</span> <span class="fu">reverse</span> helloPath</span>
<span id="cb31-179"><a href="#cb31-179" aria-hidden="true" tabindex="-1"></a>  copyFile (remote <span class="op">++</span> <span class="st">&quot;/morning.c&quot;</span>) (buildDir <span class="op">++</span> <span class="st">&quot;/morning.c&quot;</span>)</span>
<span id="cb31-180"><a href="#cb31-180" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> gcc <span class="ot">=</span> <span class="st">&quot;gcc -o &quot;</span> <span class="op">++</span> buildDir <span class="op">++</span> <span class="st">&quot;/morning &quot;</span> </span>
<span id="cb31-181"><a href="#cb31-181" aria-hidden="true" tabindex="-1"></a>                     <span class="op">++</span> buildDir <span class="op">++</span> <span class="st">&quot;/morning.c &quot;</span> </span>
<span id="cb31-182"><a href="#cb31-182" aria-hidden="true" tabindex="-1"></a>                     <span class="op">++</span> <span class="st">&quot;-L&quot;</span> <span class="op">++</span> helloOutputDir <span class="op">++</span> <span class="st">&quot; -lhello &quot;</span></span>
<span id="cb31-183"><a href="#cb31-183" aria-hidden="true" tabindex="-1"></a>                     <span class="op">++</span> <span class="st">&quot;-I&quot;</span> <span class="op">++</span> helloOutputDir</span>
<span id="cb31-184"><a href="#cb31-184" aria-hidden="true" tabindex="-1"></a>  <span class="fu">putStrLn</span> gcc</span>
<span id="cb31-185"><a href="#cb31-185" aria-hidden="true" tabindex="-1"></a>  system gcc</span>
<span id="cb31-186"><a href="#cb31-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> <span class="op">$</span> buildDir <span class="op">++</span> <span class="st">&quot;/morning&quot;</span></span>
<span id="cb31-187"><a href="#cb31-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-188"><a href="#cb31-188" aria-hidden="true" tabindex="-1"></a><span class="co">-- 개발 셸을 위한 빌드 함수 (단순화)</span></span>
<span id="cb31-189"><a href="#cb31-189" aria-hidden="true" tabindex="-1"></a><span class="ot">buildDevShell ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> [<span class="dt">FilePath</span>] <span class="ot">-&gt;</span> <span class="dt">IO</span> <span class="dt">FilePath</span></span>
<span id="cb31-190"><a href="#cb31-190" aria-hidden="true" tabindex="-1"></a>buildDevShell buildDir _ <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb31-191"><a href="#cb31-191" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> shellScript <span class="ot">=</span> <span class="st">&quot;#!/bin/sh\necho 'Entering development environment'\nexec $SHELL&quot;</span></span>
<span id="cb31-192"><a href="#cb31-192" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeFile</span> (buildDir <span class="op">&lt;/&gt;</span> <span class="st">&quot;enter-shell&quot;</span>) shellScript</span>
<span id="cb31-193"><a href="#cb31-193" aria-hidden="true" tabindex="-1"></a>  system <span class="op">$</span> <span class="st">&quot;chmod +x &quot;</span> <span class="op">++</span> buildDir <span class="op">&lt;/&gt;</span> <span class="st">&quot;enter-shell&quot;</span></span>
<span id="cb31-194"><a href="#cb31-194" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> <span class="op">$</span> buildDir <span class="op">&lt;/&gt;</span> <span class="st">&quot;enter-shell&quot;</span></span>
<span id="cb31-195"><a href="#cb31-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-196"><a href="#cb31-196" aria-hidden="true" tabindex="-1"></a><span class="co">-- 패키지 정의들 (전역으로 이동)</span></span>
<span id="cb31-197"><a href="#cb31-197" aria-hidden="true" tabindex="-1"></a><span class="ot">helloDerivation ::</span> <span class="dt">Derivation</span></span>
<span id="cb31-198"><a href="#cb31-198" aria-hidden="true" tabindex="-1"></a>helloDerivation <span class="ot">=</span> <span class="dt">Derivation</span> {</span>
<span id="cb31-199"><a href="#cb31-199" aria-hidden="true" tabindex="-1"></a>  name <span class="ot">=</span> <span class="st">&quot;hello&quot;</span>,</span>
<span id="cb31-200"><a href="#cb31-200" aria-hidden="true" tabindex="-1"></a>  source <span class="ot">=</span> <span class="st">&quot;hello.c&quot;</span>,</span>
<span id="cb31-201"><a href="#cb31-201" aria-hidden="true" tabindex="-1"></a>  buildInputs <span class="ot">=</span> [],</span>
<span id="cb31-202"><a href="#cb31-202" aria-hidden="true" tabindex="-1"></a>  buildFunc <span class="ot">=</span> buildHello,</span>
<span id="cb31-203"><a href="#cb31-203" aria-hidden="true" tabindex="-1"></a>  outputPath <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="cb31-204"><a href="#cb31-204" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-205"><a href="#cb31-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-206"><a href="#cb31-206" aria-hidden="true" tabindex="-1"></a><span class="ot">morningDerivation ::</span> <span class="dt">Derivation</span></span>
<span id="cb31-207"><a href="#cb31-207" aria-hidden="true" tabindex="-1"></a>morningDerivation <span class="ot">=</span> <span class="dt">Derivation</span> {</span>
<span id="cb31-208"><a href="#cb31-208" aria-hidden="true" tabindex="-1"></a>  name <span class="ot">=</span> <span class="st">&quot;morning&quot;</span>,</span>
<span id="cb31-209"><a href="#cb31-209" aria-hidden="true" tabindex="-1"></a>  source <span class="ot">=</span> <span class="st">&quot;morning.c&quot;</span>,</span>
<span id="cb31-210"><a href="#cb31-210" aria-hidden="true" tabindex="-1"></a>  buildInputs <span class="ot">=</span> [helloDerivation],</span>
<span id="cb31-211"><a href="#cb31-211" aria-hidden="true" tabindex="-1"></a>  buildFunc <span class="ot">=</span> buildMorning,</span>
<span id="cb31-212"><a href="#cb31-212" aria-hidden="true" tabindex="-1"></a>  outputPath <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="cb31-213"><a href="#cb31-213" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-214"><a href="#cb31-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-215"><a href="#cb31-215" aria-hidden="true" tabindex="-1"></a><span class="ot">devShellDerivation ::</span> <span class="dt">Derivation</span></span>
<span id="cb31-216"><a href="#cb31-216" aria-hidden="true" tabindex="-1"></a>devShellDerivation <span class="ot">=</span> <span class="dt">Derivation</span> {</span>
<span id="cb31-217"><a href="#cb31-217" aria-hidden="true" tabindex="-1"></a>  name <span class="ot">=</span> <span class="st">&quot;devShell&quot;</span>,</span>
<span id="cb31-218"><a href="#cb31-218" aria-hidden="true" tabindex="-1"></a>  source <span class="ot">=</span> <span class="st">&quot;&quot;</span>,</span>
<span id="cb31-219"><a href="#cb31-219" aria-hidden="true" tabindex="-1"></a>  buildInputs <span class="ot">=</span> [helloDerivation],  <span class="co">-- 개발 환경에 hello 라이브러리 포함</span></span>
<span id="cb31-220"><a href="#cb31-220" aria-hidden="true" tabindex="-1"></a>  buildFunc <span class="ot">=</span> buildDevShell,</span>
<span id="cb31-221"><a href="#cb31-221" aria-hidden="true" tabindex="-1"></a>  outputPath <span class="ot">=</span> <span class="dt">Nothing</span></span>
<span id="cb31-222"><a href="#cb31-222" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-223"><a href="#cb31-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-224"><a href="#cb31-224" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb31-225"><a href="#cb31-225" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb31-226"><a href="#cb31-226" aria-hidden="true" tabindex="-1"></a>  <span class="fu">putStrLn</span> <span class="st">&quot;Toy Nix with Flakes&quot;</span></span>
<span id="cb31-227"><a href="#cb31-227" aria-hidden="true" tabindex="-1"></a>  <span class="fu">putStrLn</span> <span class="st">&quot;-----------------&quot;</span></span>
<span id="cb31-228"><a href="#cb31-228" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-229"><a href="#cb31-229" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- 1. 기존 방식으로 패키지 빌드</span></span>
<span id="cb31-230"><a href="#cb31-230" aria-hidden="true" tabindex="-1"></a>  <span class="fu">putStrLn</span> <span class="st">&quot;\n1. Building with traditional approach:&quot;</span></span>
<span id="cb31-231"><a href="#cb31-231" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> nixStore <span class="ot">=</span> <span class="dt">NixStore</span>{ store <span class="ot">=</span> Map.empty }</span>
<span id="cb31-232"><a href="#cb31-232" aria-hidden="true" tabindex="-1"></a>  runNix nixStore morningDerivation</span>
<span id="cb31-233"><a href="#cb31-233" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-234"><a href="#cb31-234" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- 2. Flake 방식으로 패키지 빌드</span></span>
<span id="cb31-235"><a href="#cb31-235" aria-hidden="true" tabindex="-1"></a>  <span class="fu">putStrLn</span> <span class="st">&quot;\n2. Building with flakes:&quot;</span></span>
<span id="cb31-236"><a href="#cb31-236" aria-hidden="true" tabindex="-1"></a>  runFlakeCommand <span class="st">&quot;build&quot;</span> <span class="st">&quot;./example-flake&quot;</span> <span class="st">&quot;morning&quot;</span></span>
<span id="cb31-237"><a href="#cb31-237" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-238"><a href="#cb31-238" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- 3. Flake 방식으로 패키지 실행</span></span>
<span id="cb31-239"><a href="#cb31-239" aria-hidden="true" tabindex="-1"></a>  <span class="fu">putStrLn</span> <span class="st">&quot;\n3. Running with flakes:&quot;</span></span>
<span id="cb31-240"><a href="#cb31-240" aria-hidden="true" tabindex="-1"></a>  runFlakeCommand <span class="st">&quot;run&quot;</span> <span class="st">&quot;./example-flake&quot;</span> <span class="st">&quot;morning&quot;</span></span>
<span id="cb31-241"><a href="#cb31-241" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb31-242"><a href="#cb31-242" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- 4. Flake 방식으로 개발 환경 진입</span></span>
<span id="cb31-243"><a href="#cb31-243" aria-hidden="true" tabindex="-1"></a>  <span class="fu">putStrLn</span> <span class="st">&quot;\n4. Entering development shell with flakes:&quot;</span></span>
<span id="cb31-244"><a href="#cb31-244" aria-hidden="true" tabindex="-1"></a>  runFlakeCommand <span class="st">&quot;develop&quot;</span> <span class="st">&quot;./example-flake&quot;</span> <span class="st">&quot;default&quot;</span></span></code></pre></div>

<div class="comment">
  <script>
    document.addEventListener('DOMContentLoaded', loadUtterances, { once: true });
  </script>
</div>
<div style="text-align:right">Github 계정이 없는 분은 메일로 보내주세요. lionhairdino at gmail.com </div>

  </div>
  <nav class="toc toc-right js-toc relative z-1 transition--300 absolute pa4 pt5 is-position-fixed"></nav>
  <script>
    tocbot.init({
      tocSelector: '.js-toc',
      contentSelector: '.js-toc-content',
      headingSelector: 'h2, h3',
      hasInnerContainers: true,
    });
  </script>
  <div id="footer">
    © 2025 lionhairdino. All rights reserved. Generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a>
  </div>
</body>

</html>
