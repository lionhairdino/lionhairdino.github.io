<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ko" lang="ko">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <title>lionhairdino - Nix의 Flake</title>

        <meta name="description" content="Nix의 Flake를 이용해서 특정 패키지를 덮어 쓰는 방법을 살펴 봤습니다." />
        <meta property="og:description" content="Nix의 Flake를 이용해서 특정 패키지를 덮어 쓰는 방법을 살펴 봤습니다." />

        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="icon" href="https://lionhairdino.github.io/favicon.svg" />
        <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino16px.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino24px.png" sizes="24x24" />
        <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino32px.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino48px.png" sizes="48x48" />
        <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino57px.png" sizes="57x57" />
        <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino60px.png" sizes="60x60" />
        <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino64px.png" sizes="64x64" />
        <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino72px.png" sizes="72x72" />
        <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino76px.png" sizes="76x76" />
        <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino114px.png" sizes="114x114" />
        <link rel="apple-touch-icon-precomposed" href="../images/favicon/Lionhairdino120px.png" sizes="120x120" />
        <link rel="apple-touch-icon-precomposed" href="../images/favicon/Lionhairdino144px.png" sizes="144x144" />
        <link rel="shortcut icon" href="../favicon.ico" />
        <link rel="apple-touch-icon-precomposed" href="../images/favicon/Lionhairdino152px.png" sizes="152x152" />
        <link rel="apple-touch-icon-precomposed" href="../images/favicon/Lionhairdino180px.png" sizes="180x180" />
        <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino192px.png" sizes="192x192" />
        <link rel="manifest" href="../site.webmanifest" />
        <link rel="mask-icon" href="https://lionhairdino.github.io/Lionhairdino_black.svg" color="#ff7500" />
        <meta name="msapplication-TileImage" content="/images/favicon/Lionhairdino144px.png" />
        <meta name="msapplication-TileColor" content="#ff7500" />
        <meta name="theme-color" content="#ffffff" />
        <meta property="og:type" content="website" />
        <meta property="og:title" content="Nix의 Flake" />
        <meta property="og:site_name" content="Lionhairdino" />
        <meta property="og:url" content="https://lionhairdino.github.io/posts/2024-12-02-flake.html" />

        <meta property="og:image" content="https://lionhairdino.github.io/images/state400px.png" />

      <meta name="keywords" content="Nix, Flake, Override, Overlay, NixOS, Package Manager">
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-E9WZ6VXGHP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-E9WZ6VXGHP');
</script>
<script src="../script/copycode.js"></script>
<script async src="https://cse.google.com/cse.js?cx=9c53b4915cbb2605c"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.css" />
<meta name="fediverse:creator" content="@lionhairdino@mastodon.social" />
<link rel="alternate" type="application/rss+xml" title="상상 하스켈 - Lionhairdino" href="rss.xml" />
    </head>
    <body>
        <div id="header">
            <div style="display:inline-block;margin-right:5px;padding-top: 5px;" id="logo">
                <a href="../"><img style="width:30px;border:none" src="../images/favicon/Lionhairdino48px.png"></a>
            </div>
            <div style="display:inline-block;vertical-align: top;padding-top:5px;" id="navigation">
                <a href="../">lionhairdino</a>
                <a href="../about.html">about</a>
                <!--<a href="/archive.html">archive</a>-->
            </div>
            <div style="display:inline-block;font-size:0.8em;vertical-align: top;">
                <div style="display:inline-block;vertical-align: top;padding-top: 5px"></div>
                <div style="display:inline-block;width:180px;"> 
                    <div class="gcse-searchbox-only"></div>
                </div>
                <div style="display:inline-block;vertical-align: top;padding-top: 11px; padding-left: 10px;"><a rel="me" href="https://mastodon.social/@lionhairdino"><img style="width:20px;border:none" src="../images/mastodon.svg"></a></div>
                <div style="display:inline-block;vertical-align: top;padding-top: 11px; padding-left: 2px;"><a href="https://lionhairdino.bsky.social"><img style="width:18px;border:none" src="../images/bluesky.svg"></a></div>
                <div style="display:inline-block;vertical-align: top;padding-top: 11px; padding-left: 2px;"><a href="https://discordapp.com/users/lionhairdino#7687"><img style="width:20px;border:none" src="../images/discord.svg"></a></div>
                <div style="display:inline-block;vertical-align: top;padding-top: 11px; padding-left: 2px;"><a href="https://x.com/lionhairdino"><img style="width:15px;border:none" src="../images/X.svg"></a></div>
                <div style="display:inline-block;vertical-align: top;padding-top: 11px; padding-left: 2px;"><a href="https://linkedin.com/in/lionhairdino-l-baaa54244"><img style="width:20px;border:none" src="../images/linkedin.svg"></a></div>
                <div style="display:inline-block;vertical-align: top;padding-top: 11px; padding-left: 2px;"><a href="https://github.com/lionhairdino"><img style="width:20px;border:none" src="../images/github.svg"></a></div>
            </div>
            <div>
                여기 글들은 일종의 질문입니다. 용어 선택도 학계, 업계에서 쓰는 걸로 되어 있지 않고, 틀린 내용이 있을 수도 있습니다. 여기 글을 처음 읽는 분은, 먼저 <a href="warning.html">주의문</a>을 꼭 읽어보세요.
            </div>
        </div>
        <div class="js-toc-content">
            <h1>Nix의 Flake</h1>
            <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
<div class="info">
    Posted on December  2, 2024
    
</div>

<p>※ Flake 영단어 뜻은 작고 얇은 <strong>조각</strong>을 의미합니다. 아침에 먹던 그 콘프레이크의 프레이크와 같은 뜻입니다.</p>
<p>Nix 패키지 매니저 2.4부터 도입된, 아직은 실험적 기능이라 합니다만, 실험적인 것 치고는 너무 많은 곳에 쓰이고 있습니다. 어쨌든 공식적으론 여전히 실험적 특징이라 합니다.(2024.11 현재)</p>
<p>Nix 만으로 각 종 설치, 환경을 완벽히 재현할 수 있으면 좋겠지만, 현재의 Nix는 어떤 패키지의 어떤 버전을 쓰고 있는지 명확히 선언하지 않고 있습니다. 예를 들어, 어떤 채널에 있는 패키지를 참조한다고 한다면, 해당 채널이 고정된 상태가 아니라면 항상 같은 패키지를 가져 온다고 보장할 수 없습니다. 이를 보완하기 위해, 의존성 검사에 필요한 정보들을 추가로 저장해야 나중에 재현 가능성reproduicibily을 높일 수 있습니다. 이를 위해, Nix에 새로운 기능으로 <strong>Flake</strong>를 도입했습니다.</p>
<p>Flake는 의존성과 버전 정보를 <code>flake.lock</code> 파일에 저장합니다. Nixpkgs 어떤 커밋을 쓰고 있는지 커밋 해시값까자 모두 기록합니다.</p>
<p><code>flake.lock</code>에 <code>flake.nix</code>의 <code>input</code>에 써 준 모든 것들의 데이터 소스, 해시값, 버전을 기록합니다.</p>
<p>Flake 기능을 도입하기 전에 쓰던 설정 파일인 <code>configuration.nix</code>도 <code>flake.nix</code>에서 모듈로 불러 옵니다.(<code>configuration.nix</code> 파일도 하나의 모듈 파일입니다.)</p>
<p>※ 처음 볼 때 Flake를 여기 저기 쓰는데, 해석에 좀 혼란이 있었습니다. 마치 Nix라 하면, Nix OS인지, 패키지 매니저인지, 언어를 뜻하는 지 혼란스러웠던 것처럼요.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode default"><code class="sourceCode default"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>flake.nix 파일</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  |------------- 외부 모듈 flake 파일</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  |                     |------------- 외부 모듈 flake 파일 ...</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  |                     |------------- 외부 모듈 flake 파일 ...</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  |                     ...</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  |------------- 외부 모듈 flake 파일</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  |                     |------------- 외부 모듈 flake 파일 ...</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  ...                   ...</span></code></pre></div>
<p>Flake 기능의 시작점이 되는 <code>flake.nix</code> 파일을 그냥 flake라 부를 때도 있고, flake 구성에 쓰이는 모든 파일들을 flake라 부르기도 하고, 기능 자체를 Flake라 부르기도 합니다.</p>
<p><strong>flake.nix 기본 구성</strong><br />
(모든 flake 파일의 구성이 아니라, <code>flake.nix</code>파일의 구성입니다.)</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">description</span> <span class="op">=</span> ...<span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">inputs</span> <span class="op">=</span> ...<span class="op">;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">outputs</span> <span class="op">=</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>      <span class="va">lib</span> <span class="op">=</span>                  <span class="op">;</span><span class="co"># 공통 유틸리티들이 들어 있는, 스탠다드 라이브러리 같은 것</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>      <span class="va">overlays</span> <span class="op">=</span>             <span class="op">;</span><span class="co"># Nixpkgs를 수정, 확장하기 위한 오버레이 정의</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>      <span class="va">packages</span> <span class="op">=</span>             <span class="op">;</span><span class="co"># 특정 환경(default, x86_64-linux, aarch64-darwin 같은 것)에 맞는 패키지 정의</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                             ;<span class="co"># nix run 실행할 때 참조</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>      <span class="va">apps</span> <span class="op">=</span>                 <span class="op">;</span><span class="co"># nix run 으로 애플리케이션을 실행</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>      <span class="va">checks</span> <span class="op">=</span>               <span class="op">;</span><span class="co"># 테스트 정의</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>      <span class="va">defaultPacakage</span> <span class="op">=</span>      <span class="op">;</span><span class="co"># Flake가 실행될 때 기본적으로 사용할 패키지</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>                             ;<span class="co"># nix build 에서 참조</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>      <span class="va">defaultApp</span> <span class="op">=</span>           <span class="op">;</span><span class="co"># Flake가 실행될 때 기본적으로 실행할 애플리케이션</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>                             ;<span class="co"># nix run 와 연동</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>      <span class="va">devShells</span> <span class="op">=</span>            <span class="op">;</span><span class="co"># 개발 환경을 정의</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>                             ;<span class="co"># nix develop 이 호출</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>      <span class="va">nixosConfigurations</span> <span class="op">=</span>  <span class="op">;</span><span class="co"># NixOS 시스템 설정 정의</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>      <span class="va">darwinConfigurations</span> <span class="op">=</span> <span class="op">;</span><span class="co"># macOS 시스템 설정 정의</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>      <span class="va">templates</span> <span class="op">=</span>            <span class="op">;</span><span class="co"># 프로젝트를 생성할 수 있는 템플릿</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>                             ;<span class="co"># nix flake init에서 씁니다.</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>설정 파일을 작성할 때 쓸 도구(<code>lib</code>)들을 준비하고, 기본 패키지에서 사용자 입맛에 맞게 바꾸거나 추가할 패키지(<code>overlays</code>)를 설정하고, 설치할 패키지(<code>packages</code>)를 정의합니다</p>
<p>시스템을 영구적으로 변경하는 <code>sudo nixos-rebuild switch</code>에서만 이 파일을 읽어 들이는 게 아니라, <code>nix run</code>, <code>nix build</code>,… 등의 명령어들도 이 파일을 읽어 참조합니다.</p>
<h1 id="flake의-모듈-시스템">Flake의 모듈 시스템</h1>
<p><code>flake.nix</code>에서 불러 들일 모듈은 다음과 같은 구조를 가지고 있습니다. 아래 정의는 역시 Nix 언어의 <strong>함수 표현식</strong>입니다. <strong>모듈 시스템</strong>이 자동으로 값을 넣어주는, 선언 없이 사용 가능한, 몇 개의 매개 변수를 가지고 있습니다. (※ 함수라고, 사용자가 어디에 직접 적용하거나 그러진 않습니다. 함수형 언어에서 데이터와 관련 메소드들을 묶어서 가지고 다니기에 가장 적합한 구조는 함수입니다.)
<a href="https://nixos.wiki/wiki/NixOS_modules">NixOS modules - NixOS Wiki</a></p>
<p><code>flake.nix</code> 파일의 구성이 아니라 <strong>Flake 모듈 파일의 기본 구성</strong></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">lib</span><span class="op">,</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">config</span><span class="op">,</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">options</span><span class="op">,</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">pkgs</span><span class="op">,</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 위의 것들이 자주 보이는데, 아래도 표준이라 합니다.</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="va">modulePath</span><span class="op">,</span> </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="va">configDir</span><span class="op">,</span> </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="va">system</span><span class="op">,</span> </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="va">parentConfig</span><span class="op">,</span> </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="va">optionsPath</span><span class="op">,</span> </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  <span class="va">specialArgs</span><span class="op">,</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>: </span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 위 매개 변수로 들어오는 인자들을 닉스OS 모듈 시스템의 표준 인자라 합니다.</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 특별히 넘겨 주는 코드를 쓰지 않아도 자동으로 넘어 옵니다.</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 표준 인자만 받는 모듈일 경우 위는 통채로 생략하고, 파일 시작을 아래부터 할 수도 있습니다. </span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 다른 모듈에서 불러 오기</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  <span class="va">imports</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="ss">./xxx.nix</span> <span class="co"># 파일 경로만(절대, 상대 모두 가능) 써주면 됩니다.</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">];</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="va">options</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  <span class="va">config</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  <span class="va">foo</span>.<span class="va">bar</span>.<span class="va">enable</span> <span class="op">=</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 다른 옵션 선언</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ...</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="매개-변수">매개 변수</h3>
<p>※ 나중에 위 매개 변수에 값을 넘기는 건, 모듈 시스템이 알아서 합니다.</p>
<ul>
<li><code>lib</code>: nixpkg에 내장된 함수 라이브러리로, Nix 표현식을 위한 실용적인 함수들을 제공합니다.</li>
<li><code>config</code>: 이어지는 모듈 섹션에서 쓰일, 현재 환경에 있는 모든 옵션값들이 들어 있는 집합</li>
<li><code>options</code>: 현재 환경에 있는 모든 모듈에 정의되어 있는 모든 옵션 집합</li>
<li><code>pkgs</code>: 모든 nixpkgs 패키지와 유틸리티 함수를 갖고 있는 컬렉션,
입문자는 기본 값으로 <code>nixpkgs.legacyPackages."${system}"</code>이 고정되어 있다고 생각해도 됩니다.</li>
<li><code>modulePath</code>: NixOS에서만 유효한 매개 변수, NixOS의 모듈 디렉토리를 나타내며 <code>nixpkgs/nixos/modules</code>를 가리킵니다. <code>NIX_PATH</code> 환경 변수에서 가져옵니다.</li>
</ul>
<p>※ 기본값이 아닌 값을 서브 모듈에 넘길 때 <code>nixpkgs.lib.nixosSystem</code> 함수의 <code>specialArgs</code> 매개 변수를 이용하거나, <code>_module.args</code> 옵션을 이용합니다.</p>
<h3 id="imports">imports</h3>
<p>디폴트 모듈셋은 <code>nixos/modules/module-list.nix</code>에 정의되어 있고, 이들은 명시적으로 <code>imports</code>에 추가하지 않아도 됩니다.</p>
<p>표현식들에서 자주 쓰이는 내장 함수 <code>import some.nix</code>는 <code>some.nix</code>파일에 있는 닉스 표현식을 로드하는 것으로 (<code>some.nix</code> 같은 파일들은 특별히 지정된 구조를 가질 필요는 없습니다.) <code>imports = [./module.nix]</code>와 혼동하지 마세요.</p>
<h2 id="다른-flake-소스에서-소프트웨어-설치">다른 Flake 소스에서 소프트웨어 설치</h2>
<p>nixpkgs가 아닌 다른 소스에서 설치 할 수 있습니다. (※ 보통 nixpkgs에 최신 버전이 아직 안 올라 왔을 경우 자주 씁니다.)</p>
<p>코드들은 <a href="https://nixos-and-flakes.thiscute.world/nixos-with-flakes/nixos-flake-and-module-system#install-system-packages-from-other-flakes">NixOS &amp; Flakes Book</a>에서 발췌했습니다.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># flake.nix 예시</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">inputs</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">nixpkgs</span>.<span class="va">url</span> <span class="op">=</span> <span class="st">&quot;github:NixOS/nixpkgs/nixos-24.11&quot;</span><span class="op">;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># helix의 데이터 소스를 추가한다. helix의 마스터 브랜치 </span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">helix</span>.<span class="va">url</span> <span class="op">=</span> <span class="st">&quot;github:helix-editor/helix/master&quot;</span><span class="op">;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="va">outputs</span> <span class="op">=</span> inputs@<span class="op">{</span> <span class="va">self</span><span class="op">,</span> <span class="va">nixpkgs</span><span class="op">,</span> <span class="op">...</span> <span class="op">}</span>: <span class="op">{</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="va">nixosConfigurations</span>.<span class="va">my-nixos</span> <span class="op">=</span> nixpkgs.lib.nixosSystem <span class="op">{</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>      <span class="va">system</span> <span class="op">=</span> <span class="st">&quot;x86_64-linux&quot;</span><span class="op">;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>      <span class="va">specialArgs</span> <span class="op">=</span> <span class="op">{</span> <span class="kw">inherit</span> inputs<span class="op">;</span> <span class="op">};</span> <span class="co"># (가)</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>      <span class="va">modules</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>        <span class="ss">./configuration.nix</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># { _module.args = { inherit inputs; };} (나)</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># (가)와 (나)가 하는 일은 같다. 원하는 걸로 골라 쓰면 됩니다.</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>      <span class="op">];</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>flake.nix</code>의 <code>inputs</code>에서 데이터 소스(위 <code>helix</code>같은 것)를 설정해 주면, <code>specailArgs = { inherit inputs }</code>를 통해 <code>configuration.nix</code>에 넘겨서, 이 소스를 가져다 쓸 수 있습니다. <code>inputs</code> 인자를 받기 위해 매개 변수 <code>inputs</code>를 추가했습니다.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># configuration.nix</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">config</span><span class="op">,</span> <span class="va">pkgs</span><span class="op">,</span> <span class="va">inputs</span><span class="op">,</span> <span class="op">...</span> <span class="op">}</span>:</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ...</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">environment</span>.<span class="va">systemPackages</span> <span class="op">=</span> <span class="kw">with</span> pkgs<span class="op">;</span> <span class="op">[</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    git</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    vim</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    wget</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 여기서, helix input 소스에서 가져와 helix 패키지를 설치합니다.</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    inputs.helix.packages.<span class="st">&quot;</span><span class="sc">${</span>pkgs.system<span class="sc">}</span><span class="st">&quot;</span>.helix</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">];</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># ...</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>※ <code>configuration.nix</code>파일에 선언해서 영구적으로 설치하는 게 아닌, 시도만 해보려면 <code>nix run github:helix-editor/helix/master</code>를 이용할 수 있습니다.</p>
<h2 id="모듈-불러오기">모듈 불러오기</h2>
<p>https://nixos.org/manual/nixos/unstable/#sec-modularity</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># packages.nix</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">config</span><span class="op">,</span> <span class="co"># 최소 두 개의 매개 변수를 가집니다.</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">pkgs</span><span class="op">,</span>   <span class="co"># 닉스 모듈 시스템이 값을 넣어 줍니다.</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>: <span class="op">{</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="va">imports</span> <span class="op">=</span> <span class="op">[</span> <span class="co"># 외부 모듈을 불러올 때</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span><span class="bu">import</span> <span class="ss">./special-fonts-1.nix</span> <span class="op">{</span><span class="kw">inherit</span> config pkgs<span class="op">;})</span> <span class="co"># (1)</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="ss">./special-fonts-2.nix</span> <span class="co"># (2)</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">];</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="va">fontconfig</span>.<span class="va">enable</span> <span class="op">=</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>불러 올import 모듈은 두 가지 방식으로 적어 줄 수 있습니다.</p>
<p><code>(1)</code>은 불러 온import 함수를 바로 실행하는 구문입니다. 인자로 넘겨 주려면, 그냥 <strong>config</strong>와, <strong>pkgs</strong>를 쓰면 되지 않나 했는데, <code>{inherit config pkgs}</code>는 <code>{config = config; pkgs = pkgs}</code>와 같은 구문입니다. 함수 실행 결과를 <code>imports</code> 배열에 원소로 추가하고 있습니다.</p>
<p><code>(2)</code>도 닉스가 모듈로 간주하고, 내부 함수가 필요로 하는 <code>config</code>, <code>pkgs</code>를 명시하지 않아도, 모듈 시스템이 <strong>자동으로 전달</strong>합니다.
<code>import ./special-fonts-2.nix { config = config; pkgs = pkgs; }</code>를 실행하고 있다고 보면 됩니다.</p>
<p><code>special-fonts-1.nix</code> 파일이나 <code>special-fonts-2</code> 둘 모두 모듈이고, 아래 같은 모양을 가지고 있을 겁니다.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">config</span><span class="op">,</span> <span class="va">pkgs</span><span class="op">,</span> <span class="op">...}</span>: <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Configuration stuff ...</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>위와 같은 <code>packages.nix</code> 모듈 파일을 만들면, 다른 Flake 어디서든 <code>import</code> 할 수 있습니다. 주로 <code>configuration.nix</code>의 <code>imports</code> 항목이나, <code>flake.nix</code>의 <code>modules</code> 항목에서 볼 수 있습니다.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>    nixosConfigurations.mySystem = nixpkgs.lib.nixosSystem <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>      <span class="va">system</span> <span class="op">=</span> <span class="st">&quot;x86_64-linux&quot;</span><span class="op">;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>      <span class="va">modules</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        <span class="ss">./packages.nix</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">];</span></span></code></pre></div>
<h3 id="mkbefore-함수">mkBefore 함수</h3>
<p>※ 만일 <code>configuration.nix</code>와 <code>someModule.nix</code>에서 모두 <code>environment.systemPackages</code> 옵션을 정의하면, 닉스OS가 알아서 병합merge합니다. 그런데, 병합 순서가 있습니다. <code>configuration.nix</code>에 있는 것들이 가장 끝에 병합됩니다. 순서를 바꾸려면 유틸리티에 있는 <code>mkBefore</code>를 씁니다.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">boot</span>.<span class="va">kernelModules</span> <span class="op">=</span> mkBefore <span class="op">[</span><span class="st">&quot;kvm-intel&quot;</span><span class="op">]</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p><code>kernelMondules</code> 중에 가장 먼저 <code>kvm-intel</code>이 로드 됩니다. 두 모듈에 리스트 타입이 아닌데 겹치는 옵션이 있으면 병합을 못하고, 오류가 납니다.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">services</span>.<span class="va">httpd</span>.<span class="va">adminAddr</span> <span class="op">=</span> pkgs.lib.mkForce <span class="st">&quot;bob@example.org&quot;</span><span class="op">;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="mkforce-함수">mkForce 함수</h3>
<p>강제로 하나만 살아 남게 하려면 <code>mkForce</code>를 씁니다. 위에서 본 모듈 코드 모양을 보면 <code>{config, pkgs, ...}</code>로 <code>config</code>를 항상 받습니다. 모든 모듈들을 읽어 합칠 건 합치고, 겹치는 것들 처리하고 나온 결과를 묶어, 이 <code>config</code>를 통해 받습니다. 생각이 약간 복잡해지는데요. 모든 모듈들이 받는 <code>config</code>는, 어딘가에서 모듈 내용을 읽어들여 정리한 결과를 받는다니, 자신이 자신의 것을 이용하는 재귀적인 모양이 됩니다. Nix언어는 <strong>지연 평가lazy</strong>하기 때문에 이렇게 하는 게 가능합니다. (개별 항목이 자기 자신에 의존하는 경우는 안됩니다.) <a href="https://lionhairdino.github.io/posts/2020-07-07-fix.html">아마 fixpoint로 구현하고 있을 겁니다.</a></p>
<h3 id="nixos-option-명령어">nixos-option 명령어</h3>
<p>여기 저기 동일한 옵션이 정의 되어 있어서, 다 병합하고 나면 어느게 살아남는지 궁금할 때 다음 명령어를 써서 알아 볼 수 있습니다.</p>
<pre><code>$ nixos-option services.xserver.enable</code></pre>
<p>※ 불러 들인 모듈에 있는 옵션에 접근하려면, <code>config</code>를 이용하면 됩니다. 어떻게? <code>config</code>는 재귀적 결과물이라 이렇게 하는 게 가능합니다. 몇 단계를 걸쳐 모듈을 불러오든 모두 <code>config</code>를 통해 접근할 수 있습니다.</p>
<h2 id="overriding-과-overlays">Overriding 과 Overlays</h2>
<h3 id="overriding">Overriding</h3>
<p><code>pkgs</code>에 있는 닉스 패키지를 <code>override</code> 함수로 사용자가 덮어 씌울 수 있습니다. <code>override</code> 함수로 사용자 빌드 매개 변수를 정의할 수 있고, 덮어 씌워진 값을 가진, 새로운 derivation을 돌려 줍니다.
예)</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>pkgs.fcitx5<span class="op">-</span>rime.override <span class="op">{</span> <span class="va">rimeDataPkgs</span> <span class="op">=</span> <span class="op">[</span> <span class="ss">./rime-data-flypy</span> <span class="op">];</span> <span class="op">}</span></span></code></pre></div>
<p><code>fcitx5-rime</code>에 있는 <code>rimeDataPkgs</code> 매개 변수를, 커스텀 패키지 <code>rime-data-flypy</code>를 이용해 <code>override</code>합니다. <code>override</code>함수는 해당 필드만 덮어 씌워진 새로운 derivation을 만들어 냅니다.</p>
<p>패키지에 <code>override</code>로 덮어 씌울 수 있는 매개 변수가 뭐가 있는지 알아보는 방법<br />
<code>nix repl -f '&lt;nixpkgs&gt;'</code><br />
<code>:e pkgs.hello</code></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">callPackage</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">lib</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">stdenv</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">fetchurl</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">nixos</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">testers</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="op">,</span> <span class="va">hello</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>:</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 위에 있는 것들은 override로 덮어 씌우고</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>stdenv.mkDerivation <span class="op">(</span><span class="va">finalAttrs</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 아래 있는 항목들은 overrideAttrs로 덮어 씌웁니다.</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="va">pname</span> <span class="op">=</span> <span class="st">&quot;hello&quot;</span><span class="op">;</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>  <span class="va">version</span> <span class="op">=</span> <span class="st">&quot;2.12.1&quot;</span><span class="op">;</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="va">src</span> <span class="op">=</span> fetchurl <span class="op">{</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    <span class="va">url</span> <span class="op">=</span> <span class="st">&quot;mirror://gnu/hello/hello-</span><span class="sc">${</span>finalAttrs.version<span class="sc">}</span><span class="st">.tar.gz&quot;</span><span class="op">;</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="va">sha256</span> <span class="op">=</span> <span class="st">&quot;sha256-jZkUKv2SV28wsM18tCqNxoCZmLxdYH2Idh9RLibH2yA=&quot;</span><span class="op">;</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>  <span class="va">doCheck</span> <span class="op">=</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>  ...</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="op">})</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>hellowWithDebug = pkgs.hello.overrideAttrs <span class="op">(</span><span class="va">finalAttrs</span><span class="op">:</span> <span class="va">previousAttrs</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co">#                                             인자1         인자2</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">doCheck</span> <span class="op">=</span> <span class="cn">false</span><span class="op">;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="op">})</span></span></code></pre></div>
<p>인자 두 개가 커링된 람다 함수로 보면 됩니다.</p>
<p>위 hello 파일에 보이는 속성들 말고, <code>stdenv.mkDerivation</code>에 있는 <code>separateDebugInfo</code>같은 속성도 덮어 씌울 수 있습니다.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>hellowWithDebug = pkgs.hello.overrideAttrs <span class="op">(</span><span class="va">finalAttrs</span><span class="op">:</span> <span class="va">previousAttrs</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">separateDebugInfo</span> <span class="op">=</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="op">})</span></span></code></pre></div>
<p><code>:e stdenv.mkDerivation</code>으로 매개 변수 목록을 뽑아 볼 수 있습니다.</p>
<h3 id="overlays">overlays</h3>
<p>디폴트 nixpkgs 인스턴스에서, <strong>전역적</strong>으로 derivations을 수정하기 위해 제공되는 기능입니다. 전역적이란 말이 무슨 말이냐 하면, <code>override</code>로 덮어 씌운 건 해당 패키지만 바뀌치기 하고, 다른 패키지가 해당 패키지를 참조하고 있다면, 그 때는 여전히 수정되지 않은 패키지를 참조합니다. 글로벌하게 바꾸려면 <code>overlays</code>를 씁니다.</p>
<p>Flake를 쓰지 않는 Nix에서는 <code>~/.config/nixpkgs/overlays.nix</code> 또는 <code>~/.config/nixpkgs/overlays/*.nix</code> 파일들로 overlays를 구성할 수 있었지만, Flake는 재현 가능성을 위해 Git 저장소를 벗어나는 설정을 쓸 수 없습니다.</p>
<p>Home Manager와 NixOS는 <code>nixpkgs.overlays</code> 옵션을 가지고 있습니다.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ./overlays/default.nix</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">config</span><span class="op">,</span> <span class="va">pkgs</span><span class="op">,</span> <span class="va">lib</span><span class="op">,</span> <span class="op">...</span> <span class="op">}</span>:</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">nixpkgs</span>.<span class="va">overlays</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Overlay 1: 상속 관계를 표현하기 위해 `self`와 `super`를 씁니다.</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span><span class="va">self</span><span class="op">:</span> <span class="va">super</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>      <span class="va">google-chrome</span> <span class="op">=</span> super.google<span class="op">-</span>chrome.override <span class="op">{</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">commandLineArgs</span> <span class="op">=</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;--proxy-server='https=127.0.0.1:3128;http=127.0.0.1:3128'&quot;</span><span class="op">;</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>      <span class="op">};</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">})</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Overlay 2: 새로운 것과 오래된 것을 나타내는 의미로 `final`과 `prev`를 씁니다.</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span><span class="va">final</span><span class="op">:</span> <span class="va">prev</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>      <span class="va">steam</span> <span class="op">=</span> prev.steam.override <span class="op">{</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>        <span class="va">extraPkgs</span> <span class="op">=</span> <span class="va">pkgs</span><span class="op">:</span> <span class="kw">with</span> pkgs<span class="op">;</span> <span class="op">[</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>          keyutils</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>          libkrb5</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>          libpng</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>          libpulseaudio</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>          libvorbis</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>          stdenv.cc.cc.lib</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>          xorg.libXcursor</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>          xorg.libXi</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>          xorg.libXinerama</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>          xorg.libXScrnSaver</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">];</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">extraProfile</span> <span class="op">=</span> <span class="st">&quot;export GDK_SCALE=2&quot;</span><span class="op">;</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>      <span class="op">};</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">})</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Overlay 3: 다른 파일에 overlays를 정의합니다.</span></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ./overlays/overlay3/default.nix 의 내용은 위와 같습니다.</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># `(final: prev: { xxx = prev.xxx.override { ... }; })`</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span><span class="bu">import</span> <span class="ss">./overlay3</span><span class="op">)</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>  <span class="op">];</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>위와 같이 작성하고 <code>flake.nix</code>는 아래와 같이 작성해서 오버레이를 불러 옵니다.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ./flake.nix</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">inputs</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ...</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="va">outputs</span> <span class="op">=</span> inputs@<span class="op">{</span> <span class="va">nixpkgs</span><span class="op">,</span> <span class="op">...</span> <span class="op">}</span>: <span class="op">{</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">nixosConfigurations</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>      <span class="va">my-nixos</span> <span class="op">=</span> nixpkgs.lib.nixosSystem <span class="op">{</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">system</span> <span class="op">=</span> <span class="st">&quot;x86_64-linux&quot;</span><span class="op">;</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">modules</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>          <span class="ss">./configuration.nix</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>          <span class="op">(</span><span class="bu">import</span> <span class="ss">./overlays</span><span class="op">)</span> <span class="co"># 이렇게 폴더만 써주면, default.nix를 찾는다.</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">];</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>      <span class="op">};</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>폴더에 있는 모든 오버레이를 불러 오려면</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">pkgs</span><span class="op">,</span> <span class="va">lib</span><span class="op">,</span> <span class="op">...</span> <span class="op">}</span>:</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">overlays</span> <span class="op">=</span> <span class="bu">builtins</span>.attrValues <span class="op">(</span><span class="bu">builtins</span>.readDir <span class="ss">./overlays</span><span class="op">);</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">overlays</span> <span class="op">=</span> overlays<span class="op">;</span> <span class="op">}</span></span></code></pre></div>
<h3 id="specialargs">specialArgs</h3>
<div class="sourceCode" id="cb19"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>nixosConfigurations = <span class="op">{</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">my-nixos</span> <span class="op">=</span> nixpkgs.lib.nixosSystem <span class="kw">rec</span> <span class="op">{</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">system</span> <span class="op">=</span> ...</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    specialArgs = s1 <span class="co"># &lt;-- 자동으로 modules에 넘어 갑니다.</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    modules = <span class="op">[</span>m1 m2<span class="op">]</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p><code>m1</code>과 <code>m2</code>는 <code>s1</code>에 접근 가능하다. <code>specialArgs</code>는 자동으로 모듈에 넘어 갑니다.</p>
<h2 id="rust-overlay의-flake.nix-분석">rust-overlay의 flake.nix 분석</h2>
<p><a href="https://github.com/oxalica/rust-overlay/blob/c65e91d4a33abc3bc4a892d3c5b5b378bad64ea1/flake.nix">rust-overlay/flake.nix</a>에서 가져 왔습니다.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">description</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="st">    Pure and reproducible overlay for binary distributed rust toolchains.</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="st">    A compatible but better replacement for rust overlay of github:mozilla/nixpkgs-mozilla.</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="st">  ''</span><span class="op">;</span> <span class="co"># ''로 여러 줄 텍스트를 넣어 줄 수 있다.</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  <span class="va">inputs</span> <span class="op">=</span> <span class="op">{</span> <span class="co"># flake의 입력</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">nixpkgs</span>.<span class="va">url</span> <span class="op">=</span> <span class="st">&quot;github:NixOS/nixpkgs/nixpkgs-unstable&quot;</span><span class="op">;</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="va">outputs</span> <span class="op">=</span> <span class="op">{</span> <span class="va">self</span><span class="op">,</span> <span class="va">nixpkgs</span> <span class="op">}</span>@<span class="va">inputs</span><span class="op">:</span> <span class="kw">let</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="va">inherit</span> (<span class="va">nixpkgs</span>) <span class="va">lib</span>; <span class="co"># lib = nixpkgs.lib 보통 유틸리티 함수를 쓸 때 필요한 것 같다.</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="va">inherit</span> (<span class="va">lib</span>) <span class="va">filterAttrs</span> <span class="va">mapAttrs'</span> <span class="va">replaceStrings</span>;  </span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># filterAttrs = lib.filterAttrs 속성 필터</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># mapAttrs' = lib.mapAttrs' 속성 매핑</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># replaceStrings = lib.replaceStrings 문자열 치환</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    <span class="va">forEachSystem</span> <span class="op">=</span> lib.genAttrs lib.systems.flakeExposed<span class="op">;</span> <span class="co"># 함수 정의</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                            지원되는 시스템 목록 제공</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                            x86_64-linux, aarch64-linux, x86_64-darwin 같은 것들</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    <span class="va">overlay</span> <span class="op">=</span> <span class="bu">import</span> <span class="ss">./.</span><span class="op">;</span> <span class="co"># 현재 디렉토리에서 오버레이 가져 오기. 아마도 default.nix?</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    <span class="va">defaultDistRoot</span> <span class="op">=</span> <span class="bu">import</span> <span class="ss">./lib/dist-root.nix</span><span class="op">;</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    <span class="va">mkManifests</span> <span class="op">=</span> <span class="va">distRoot</span><span class="op">:</span> <span class="bu">import</span> <span class="ss">./lib/manifests.nix</span> <span class="op">{</span> <span class="kw">inherit</span> lib distRoot<span class="op">;</span> <span class="op">};</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">#                                                    distRoot = lib.distRoot</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rust 도구 체인 인터페이스 빌더</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Builder to construct `rust-bin` interface on an existing `pkgs`.</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This would be immutable, non-intrusive and (hopefully) can benefit from</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># flake eval-cache.</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">#</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Note that this does not contain compatible attrs for mozilla-overlay.</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rust 바이너리 인터페이스</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>    <span class="va">mkRustBin</span> <span class="op">=</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>      <span class="op">{</span> <span class="va">distRoot</span> <span class="op">?</span> defaultDistRoot <span class="op">}</span>: <span class="co"># 값이 들어 오지 않으면, defaultDistRoot를 사용</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>                                      <span class="co"># 매개 변수의 기본값을 정의하는 구문</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>      <span class="va">pkgs</span><span class="op">:</span></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>      lib.fix <span class="op">(</span><span class="va">rust-bin</span><span class="op">:</span> <span class="bu">import</span> <span class="ss">./lib/rust-bin.nix</span> <span class="op">{</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">inherit</span> lib pkgs<span class="op">;</span> <span class="co"># pkgs = lib.pkgs</span></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>        <span class="kw">inherit</span> <span class="op">(</span>pkgs.rust<span class="op">)</span> toRustTarget<span class="op">;</span> <span class="co"># toRustTarget = pkgs.rust.toRustTarget</span></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>        <span class="kw">inherit</span> <span class="op">(</span>rust<span class="op">-</span>bin<span class="op">)</span> nightly<span class="op">;</span> <span class="co"># nightly = rust-bin.nightly</span></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>        <span class="va">manifests</span> <span class="op">=</span> mkManifests distRoot<span class="op">;</span> <span class="co"># manifest: 파일 메타 정보 목록</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>                                          <span class="co"># 아마도 버전 목록?</span></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>                                          <span class="co"># {이름, 버전, 의존성, ...}을 받아 메니페스트 생성</span></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>      <span class="op">});</span></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>  <span class="kw">in</span> <span class="op">{</span></span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>    <span class="va">lib</span> <span class="op">=</span> <span class="op">{</span> </span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>      <span class="va">_internal</span> <span class="op">=</span> <span class="op">{</span> <span class="co"># 내부에서만 사용할 라이브러리</span></span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>        <span class="va">defaultManifests</span> <span class="op">=</span> mkManifests defaultDistRoot<span class="op">;</span></span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>      <span class="op">};</span></span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>      <span class="kw">inherit</span> mkRustBin<span class="op">;</span> <span class="co"># 외부에서 접근 가능한 Rust 도구 체인 빌더</span></span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>    <span class="va">overlays</span> <span class="op">=</span> <span class="op">{</span> <span class="co"># 패키지에서 특정 부분만 바뀌 치기 위한 오버레이</span></span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>      <span class="va">default</span> <span class="op">=</span> overlay<span class="op">;</span> <span class="co"># 현재 폴더에서 가져온 오버레이(위에서 정의된 변수)</span></span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>      <span class="va">rust-overlay</span> <span class="op">=</span> overlay<span class="op">;</span></span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: Flake outputs except `overlay[s]` are not stabilized yet.</span></span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>    <span class="va">packages</span> <span class="op">=</span> <span class="co"># 다양한 Rust 버전을 정의</span></span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span></span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a>        <span class="va">select</span> <span class="op">=</span> <span class="va">version</span><span class="op">:</span> <span class="va">comps</span><span class="op">:</span> <span class="co"># 함수</span></span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a>          <span class="kw">if</span> comps <span class="op">?</span> default <span class="kw">then</span></span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a>            comps.default <span class="op">//</span> <span class="op">{</span></span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a>              <span class="va">minimal</span> <span class="op">=</span> comps.minimal <span class="kw">or</span> <span class="op">(</span><span class="bu">throw</span> <span class="st">&quot;missing profile 'minimal' for </span><span class="sc">${</span>version<span class="sc">}</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a>          <span class="kw">else</span></span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a>            <span class="cn">null</span><span class="op">;</span></span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a>        <span class="va">result</span> <span class="op">=</span> <span class="va">rust-bin</span><span class="op">:</span> <span class="co"># 함수</span></span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a>          mapAttrs' <span class="op">(</span><span class="va">version</span><span class="op">:</span> <span class="va">comps</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a>            <span class="va">name</span> <span class="op">=</span> <span class="kw">if</span> version == <span class="st">&quot;latest&quot;</span></span>
<span id="cb20-77"><a href="#cb20-77" aria-hidden="true" tabindex="-1"></a>              <span class="kw">then</span> <span class="st">&quot;rust&quot;</span> <span class="co"># latest면 그냥 rust</span></span>
<span id="cb20-78"><a href="#cb20-78" aria-hidden="true" tabindex="-1"></a>              <span class="kw">else</span> <span class="st">&quot;rust_</span><span class="sc">${</span>replaceStrings <span class="op">[</span><span class="st">&quot;.&quot;</span><span class="op">]</span> <span class="op">[</span><span class="st">&quot;_&quot;</span><span class="op">]</span> version<span class="sc">}</span><span class="st">&quot;</span><span class="op">;</span></span>
<span id="cb20-79"><a href="#cb20-79" aria-hidden="true" tabindex="-1"></a>                  <span class="co"># ex) rust_1_81_0</span></span>
<span id="cb20-80"><a href="#cb20-80" aria-hidden="true" tabindex="-1"></a>            <span class="va">value</span> <span class="op">=</span> select version comps<span class="op">;</span></span>
<span id="cb20-81"><a href="#cb20-81" aria-hidden="true" tabindex="-1"></a>          <span class="op">})</span> rust<span class="op">-</span>bin.stable <span class="op">//</span></span>
<span id="cb20-82"><a href="#cb20-82" aria-hidden="true" tabindex="-1"></a>          mapAttrs' <span class="op">(</span><span class="va">version</span><span class="op">:</span> <span class="va">comps</span><span class="op">:</span> <span class="op">{</span> <span class="co"># 고차 함수를 인자로 넘기고 있다.</span></span>
<span id="cb20-83"><a href="#cb20-83" aria-hidden="true" tabindex="-1"></a>            <span class="va">name</span> <span class="op">=</span> <span class="kw">if</span> version == <span class="st">&quot;latest&quot;</span></span>
<span id="cb20-84"><a href="#cb20-84" aria-hidden="true" tabindex="-1"></a>              <span class="kw">then</span> <span class="st">&quot;rust-nightly&quot;</span></span>
<span id="cb20-85"><a href="#cb20-85" aria-hidden="true" tabindex="-1"></a>              <span class="kw">else</span> <span class="st">&quot;rust-nightly_</span><span class="sc">${</span>version<span class="sc">}</span><span class="st">&quot;</span><span class="op">;</span></span>
<span id="cb20-86"><a href="#cb20-86" aria-hidden="true" tabindex="-1"></a>            <span class="va">value</span> <span class="op">=</span> select version comps<span class="op">;</span></span>
<span id="cb20-87"><a href="#cb20-87" aria-hidden="true" tabindex="-1"></a>          <span class="op">})</span> rust<span class="op">-</span>bin.nightly <span class="op">//</span></span>
<span id="cb20-88"><a href="#cb20-88" aria-hidden="true" tabindex="-1"></a>          mapAttrs' <span class="op">(</span><span class="va">version</span><span class="op">:</span> <span class="va">comps</span><span class="op">:</span> <span class="op">{</span></span>
<span id="cb20-89"><a href="#cb20-89" aria-hidden="true" tabindex="-1"></a>            <span class="va">name</span> <span class="op">=</span> <span class="kw">if</span> version == <span class="st">&quot;latest&quot;</span></span>
<span id="cb20-90"><a href="#cb20-90" aria-hidden="true" tabindex="-1"></a>              <span class="kw">then</span> <span class="st">&quot;rust-beta&quot;</span></span>
<span id="cb20-91"><a href="#cb20-91" aria-hidden="true" tabindex="-1"></a>              <span class="kw">else</span> <span class="st">&quot;rust-beta_</span><span class="sc">${</span>version<span class="sc">}</span><span class="st">&quot;</span><span class="op">;</span></span>
<span id="cb20-92"><a href="#cb20-92" aria-hidden="true" tabindex="-1"></a>            <span class="va">value</span> <span class="op">=</span> select version comps<span class="op">;</span></span>
<span id="cb20-93"><a href="#cb20-93" aria-hidden="true" tabindex="-1"></a>          <span class="op">})</span> rust<span class="op">-</span>bin.beta<span class="op">;</span></span>
<span id="cb20-94"><a href="#cb20-94" aria-hidden="true" tabindex="-1"></a>        <span class="va">result'</span> <span class="op">=</span> <span class="va">rust-bin</span><span class="op">:</span> filterAttrs <span class="op">(</span><span class="va">name</span><span class="op">:</span> <span class="va">drv</span><span class="op">:</span> drv <span class="op">!</span>= <span class="cn">null</span><span class="op">)</span> <span class="op">(</span>result rust<span class="op">-</span>bin<span class="op">);</span></span>
<span id="cb20-95"><a href="#cb20-95" aria-hidden="true" tabindex="-1"></a>      <span class="kw">in</span></span>
<span id="cb20-96"><a href="#cb20-96" aria-hidden="true" tabindex="-1"></a>      forEachSystem <span class="op">(</span><span class="va">system</span><span class="op">:</span></span>
<span id="cb20-97"><a href="#cb20-97" aria-hidden="true" tabindex="-1"></a>        result' <span class="op">(</span>mkRustBin <span class="op">{}</span> nixpkgs.legacyPackages.$<span class="op">{</span><span class="va">system</span><span class="op">})</span></span>
<span id="cb20-98"><a href="#cb20-98" aria-hidden="true" tabindex="-1"></a>        <span class="op">//</span> <span class="op">{</span> <span class="va">default</span> <span class="op">=</span> self.packages.$<span class="op">{</span><span class="va">system</span><span class="op">}</span>.rust<span class="op">;</span> <span class="op">}</span></span>
<span id="cb20-99"><a href="#cb20-99" aria-hidden="true" tabindex="-1"></a>      <span class="op">);</span></span>
<span id="cb20-100"><a href="#cb20-100" aria-hidden="true" tabindex="-1"></a>      <span class="co"># todo: legacyPackage가 구버전 패키지를 뜻한다는데,</span></span>
<span id="cb20-101"><a href="#cb20-101" aria-hidden="true" tabindex="-1"></a>      <span class="co"># 신버전은 뭐고, 구버전은 뭐지?</span></span>
<span id="cb20-102"><a href="#cb20-102" aria-hidden="true" tabindex="-1"></a>    <span class="va">checks</span> <span class="op">=</span> forEachSystem <span class="op">(</span><span class="bu">import</span> <span class="ss">./tests</span> inputs<span class="op">);</span></span>
<span id="cb20-103"><a href="#cb20-103" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb20-104"><a href="#cb20-104" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="genattrs-함수">genAttrs 함수</h3>
<p><code>lib.genAttrs :: [String] -&gt; (String -&gt; a) -&gt; {String = a}</code></p>
<div class="sourceCode" id="cb21"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>lib.genAttrs <span class="op">[</span> <span class="st">&quot;x86_64-linux&quot;</span> <span class="st">&quot;aarch64-darwin&quot;</span> <span class="op">]</span> <span class="op">(</span><span class="va">system</span><span class="op">:</span> <span class="st">&quot;Hello, </span><span class="sc">${</span>system<span class="sc">}</span><span class="st">!&quot;</span><span class="op">)</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="co">#                                                           함수 </span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 아래와 같습니다. </span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;</span>x86_64-linux<span class="st">&quot;</span> <span class="op">=</span> <span class="st">&quot;Hello, x86_64-linux!&quot;</span><span class="op">;</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;aarch64-darwin&quot;</span> <span class="op">=</span> <span class="st">&quot;Hello, aarch64-darwin!&quot;</span><span class="op">;</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="filterattrs-함수">filterAttrs 함수</h3>
<p>속성 필터</p>
<h3 id="mapattrs-함수">mapAttrs’ 함수</h3>
<p>속성 매핑</p>
<h3 id="replacestrings-함수">replaceStrings 함수</h3>
<p>문자열 치환</p>
<p>Nixpkgs Manual <a href="https://ryantm.github.io/nixpkgs/" class="uri">https://ryantm.github.io/nixpkgs/</a></p>

<div class="comment">
<script src="https://utteranc.es/client.js" repo="lionhairdino/lionhairdino.github.io" issue-term="url" theme="github-light" crossorigin="anonymous" async>
</script>
</div>
<div style="text-align:right">Github 계정이 없는 분은 메일로 보내주세요. lionhairdino at gmail.com </div>
        </div>
        <nav class="toc toc-right js-toc relative z-1 transition--300 absolute pa4 pt5 is-position-fixed"></nav>
        <div id="footer">
            © 2022 lionhairdino. All rights reserved. Generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>
        <script>
            tocbot.init({
                tocSelector: '.js-toc',
                contentSelector: '.js-toc-content',
                headingSelector: 'h2, h3',
                hasInnerContainers: true,
            });
        </script>
    </body>
</html>
