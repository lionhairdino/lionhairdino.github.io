<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ko" lang="ko">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <title>lionhairdino - 모나드 트랜스포머 - Monad Transformer 그리고 mtl</title>

        <meta name="description" content="상용 프로그램을 짜려면 거의 필수적으로 모나드 트랜스포머 스택을 쌓게 됩니다. 그럼 각 모나드들의 특정적인 메소드들에 접근하기가 까다로워집니다. 이 걸 영리하게 GHC에게 떠넘겨 버리는 라이브러리입니다." />
        <meta property="og:description" content="상용 프로그램을 짜려면 거의 필수적으로 모나드 트랜스포머 스택을 쌓게 됩니다. 그럼 각 모나드들의 특정적인 메소드들에 접근하기가 까다로워집니다. 이 걸 영리하게 GHC에게 떠넘겨 버리는 라이브러리입니다." />

        <link rel="stylesheet" type="text/css" href="../css/default.css" />
        <link rel="icon" href="https://lionhairdino.github.io/favicon.svg" />
        <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino16px.png" sizes="16x16" />
        <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino24px.png" sizes="24x24" />
        <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino32px.png" sizes="32x32" />
        <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino48px.png" sizes="48x48" />
        <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino57px.png" sizes="57x57" />
        <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino60px.png" sizes="60x60" />
        <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino64px.png" sizes="64x64" />
        <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino72px.png" sizes="72x72" />
        <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino76px.png" sizes="76x76" />
        <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino114px.png" sizes="114x114" />
        <link rel="apple-touch-icon-precomposed" href="../images/favicon/Lionhairdino120px.png" sizes="120x120" />
        <link rel="apple-touch-icon-precomposed" href="../images/favicon/Lionhairdino144px.png" sizes="144x144" />
        <link rel="shortcut icon" href="../favicon.ico" />
        <link rel="apple-touch-icon-precomposed" href="../images/favicon/Lionhairdino152px.png" sizes="152x152" />
        <link rel="apple-touch-icon-precomposed" href="../images/favicon/Lionhairdino180px.png" sizes="180x180" />
        <link rel="icon" type="image/png" href="../images/favicon/Lionhairdino192px.png" sizes="192x192" />
        <link rel="manifest" href="../site.webmanifest" />
        <link rel="mask-icon" href="https://lionhairdino.github.io/Lionhairdino_black.svg" color="#ff7500" />
        <meta name="msapplication-TileImage" content="/images/favicon/Lionhairdino144px.png" />
        <meta name="msapplication-TileColor" content="#ff7500" />
        <meta name="theme-color" content="#ffffff" />
        <meta property="og:type" content="website" />
        <meta property="og:title" content="모나드 트랜스포머 - Monad Transformer 그리고 mtl" />
        <meta property="og:site_name" content="Lionhairdino" />
        <meta property="og:url" content="https://lionhairdino.github.io/posts/2020-07-16-MonadTransformer.html" />

        <meta property="og:image" content="https://lionhairdino.github.io/images/mtl.png" />

      <meta name="keywords" content="모나드 트랜스포머, Monad Transformer, mtl, 결과 타입 다형성">
<script src="../script/copycode.js"></script>

    </head>
    <body>
        <div id="header">
            <div id="navigation">
                <a href="../">lionhairdino</a> 
                <a href="../about.html">about</a>
                <!--<a href="/archive.html">archive</a>-->
            </div>
        </div>

        <div id="content">
            <h1>모나드 트랜스포머 - Monad Transformer 그리고 mtl</h1>

            <link rel="stylesheet" type="text/css" href="../css/syntax.css" />
<div class="info">
    Posted on July 16, 2020
    
</div>

<p>이 글을 읽으시려면 <code>IO</code> 모나드와 <code>Reader</code> 모나드의 동작을 알고 있어야 합니다.</p>
<h3 id="목차">목차</h3>
<ul>
<li><a href="#io">IO</a></li>
<li><a href="#io-위에-reader">IO 위에 Reader</a></li>
<li><a href="#mtl">mtl</a>
<ul>
<li><a href="#return-type-polymorphic">Return Type Polymorphic</a></li>
<li><a href="#mtl-핵심-아이디어">mtl 핵심 아이디어</a></li>
</ul></li>
<li><a href="#자주-만나는-에러-no-instance">자주 만나는 에러 No instance</a></li>
<li><a href="#에러-수정">에러 수정</a></li>
</ul>
<p>라이브러리를 제외하고, <code>IO</code>가 없는 프로그램은 없습니다. 데이터를 받고, 처리를 하고, 출력을 해주는게 프로그램입니다. 예를 들어, 소수를 구하는 프로그램은 입력Input도 없고, 출력Ouput도 없는 것 아니냐라고 생각할 수도 있습니다. 입력은 없지만, 구한 소수를 눈에 보이지 않게 하면 의미가 없으니 결국 출력이 필요합니다. 소수를 구하는 함수 자체에는 출력이 없지만, 나중에 GHCi 등에서 함수를 부르면 결과값을 출력해주는 작업을 GHCi가 대신하게 됩니다. 어찌 됐든 결론은, 언젠가 <code>IO</code>는 반드시 필요하다는 얘기입니다.</p>
<h2 id="io">IO</h2>
<p><code>IO</code> 모나드를 반드시 써야 하고, 모든 <code>IO</code> 액션들이 설정값을 필요로 하는 경우를 생각해 봅시다. 이미 <code>IO</code>로 체이닝한 상태인데 <code>Reader</code> 모나드를 쓰고 싶을 때는 어떻게 할까요? 이미 <code>IO</code> 액션이 <code>(..(..(..())))</code> 이렇게 엮여 있는데, 액션 하나가 실행 할 때마다 <code>Reader</code> 속성이 발현되도록 다시 엮어야 합니다.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ot">act1 ::</span> <span class="dt">IO</span> ()</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>act1 <span class="ot">=</span> <span class="fu">putStrLn</span> <span class="st">&quot; 나는 OO과 영화를 봤다. &quot;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="ot">act2 ::</span> <span class="dt">IO</span> ()</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>act2 <span class="ot">=</span> <span class="fu">putStrLn</span> <span class="st">&quot; 나는 OO과 밥을 먹었다. &quot;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="ot">act3 ::</span> <span class="dt">IO</span> ()</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>act3 <span class="ot">=</span> <span class="fu">putStrLn</span> <span class="st">&quot; 나는 OO과 술을 먹었다. &quot;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>act <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  act1</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  act2</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  act3</span></code></pre></div>
<p>OO에 입력 받은 이름을 넣고 싶으면</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ot">act1 ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>act1 who <span class="ot">=</span> <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;나는 &quot;</span> <span class="op">++</span> who <span class="op">++</span> <span class="st">&quot;와 영화를 봤다. &quot;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="ot">act2 ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>act2 who <span class="ot">=</span> <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;나는 &quot;</span> <span class="op">++</span> who <span class="op">++</span> <span class="st">&quot;와 밥을 먹었다. &quot;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="ot">act3 ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>act3 who <span class="ot">=</span> <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;나는 &quot;</span> <span class="op">++</span> who <span class="op">++</span> <span class="st">&quot;와 술을 먹었다. &quot;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>act who <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  act1 who</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  act2 who</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  act3 who</span></code></pre></div>
<p>이렇게 모든 함수들에 필요한 매개 변수를 만들면 되지만, 액션 종류가 많아지고 필요한 정보가 많아지면 꽤 성가진 모양이 될 겁니다.</p>
<h2 id="io-위에-reader">IO 위에 Reader</h2>
<p>이럴 때, 모나드 트랜스포머를 이용해서 다음처럼 구현할 수 있습니다. 아래는 좀 억지스러운 예시라 오히려 소스가 늘어났지만, 실용 프로그램에서는 대부분 줄어드는 효과도 있고, 무엇보다 유연하게 쓸 수 있다는 장점이 있습니다.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ot">act1 ::</span> <span class="dt">ReaderT</span> <span class="dt">String</span> <span class="dt">IO</span> ()</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>act1 <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  who <span class="ot">&lt;-</span> ask</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  liftIO <span class="op">$</span> <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;나는 &quot;</span> <span class="op">++</span> who <span class="op">++</span> <span class="st">&quot;와 영화를 봤다. &quot;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="ot">act2 ::</span> <span class="dt">ReaderT</span> <span class="dt">String</span> <span class="dt">IO</span> ()</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>act2 <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  who <span class="ot">&lt;-</span> ask</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  liftIO <span class="op">$</span> <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;나는 &quot;</span> <span class="op">++</span> who <span class="op">++</span> <span class="st">&quot;와 밥을 먹었다. &quot;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="ot">act3 ::</span> <span class="dt">ReaderT</span> <span class="dt">String</span> <span class="dt">IO</span> ()</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>act3 <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  who <span class="ot">&lt;-</span> ask</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  liftIO <span class="op">$</span> <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;나는 &quot;</span> <span class="op">++</span> who <span class="op">++</span> <span class="st">&quot;와 술을 먹었다. &quot;</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>act who <span class="ot">=</span> runReaderT ( <span class="kw">do</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    act1</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    act2</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    act3</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>  ) who  </span></code></pre></div>
<p><code>act</code>는 <code>IO</code> 모나드와 <code>Reader</code> 모나드의 특징을 모두 가진 모나드 액션이 됐습니다. 이렇게 두 개 이상의 모나드를 섞어서 써야 할 때 모나드 트랜스포머를 씁니다.</p>
<p>모나드의 특징은 바인드로 발현됩니다. <code>IO</code> 모나드와 <code>Reader</code> 모나드 특징 모두가 발현 되려면 <em>두 모나드의 바인드가 모두 실행</em>되어야 합니다.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">newtype</span> <span class="dt">ReaderT</span> r innerm a <span class="ot">=</span> <span class="dt">ReaderT</span> {<span class="ot"> runReaderT ::</span> r <span class="ot">-&gt;</span> innerm a }</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> (<span class="dt">Monad</span> m) <span class="ot">=&gt;</span> <span class="dt">Monad</span> (<span class="dt">ReaderT</span> r m) <span class="kw">where</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span> <span class="ot">=</span> lift <span class="op">.</span> <span class="fu">return</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  rtm <span class="op">&gt;&gt;=</span> k <span class="ot">=</span> <span class="dt">ReaderT</span> <span class="op">$</span> \r <span class="ot">-&gt;</span> <span class="kw">do</span> <span class="co">--(1)</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                       a <span class="ot">&lt;-</span> runReaderT rtm r</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                       runReaderT (k a) r</span></code></pre></div>
<p>바인드만 살펴 보도록 하겠습니다.<br />
바인드 정의를 보면 인스턴스 헤드에 있는 <code>m</code>이 보이지 않습니다. <code>m</code>은 (1) <code>do</code>구문에 가려져 있는 바인드의 인스턴스를 선택할 때 단서로 쓰입니다. 여기서 <code>do</code>는 <code>m</code>모나드의 <code>do</code>입니다.<br />
실제 <code>act1</code> 과 <code>act2</code> 를 바인딩 했을 때 무슨 일이 일어나는지 보겠습니다.</p>
<p><code>do</code>를 걷어내서 바인드가 보이게 하면</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>act1 <span class="op">&gt;&gt;=</span> \_ <span class="ot">-&gt;</span> act2 <span class="ot">=</span></span></code></pre></div>
<p>위 바인드 정의에 그대로 넣으면</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>  <span class="dt">ReaderT</span> <span class="op">$</span> \r <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>            a <span class="ot">&lt;-</span> runReaderT act1 r <span class="co">---(1)</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>            runReaderT ((\_ <span class="ot">-&gt;</span> act2) a) r <span class="co">---(2)</span></span></code></pre></div>
<p><code>act1</code>과 <code>act2</code>의 바인딩 결과는 <code>r</code>을 받는 함수를 <code>ReaderT</code>로 감싼 상태입니다.<br />
여기에 <code>act</code> 함수에서처럼 <code>runReaderT</code>로 <code>r</code>을 넣어주면 그 때 실행됩니다.<br />
(1)번과 (2)번 사이에는 <code>m</code>의 <code>bind</code>가 숨어 있습니다.</p>
<p>여기서는 <code>r</code>값으로 “친구” 넣어 보겠습니다.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>runRederT ( <span class="dt">ReaderT</span> <span class="op">$</span> \r <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>            a <span class="ot">&lt;-</span> runReaderT act1 r</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>            runReaderT ((\_ <span class="ot">-&gt;</span> act2) a) r</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>) <span class="st">&quot;친구&quot;</span></span></code></pre></div>
<p><code>runReaderT</code>는 <code>ReaderT</code> 안에 있는 함수를 꺼내는 작업을 합니다.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>\r <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    a <span class="ot">&lt;-</span> runReaderT act1 r</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    runReaderT ((\_ <span class="ot">-&gt;</span> act2) a) r</span></code></pre></div>
<p>이 함수에 “친구”를 넣으면,</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> runReaderT act1 <span class="st">&quot;친구&quot;</span> <span class="co">--- (1)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>runReaderT ((\_ <span class="ot">-&gt;</span> act2) a) <span class="st">&quot;친구&quot;</span> <span class="co">---(2)</span></span></code></pre></div>
<ol type="1">
<li><p><code>act1</code>은 <code>IO</code> 작업 <code>putStrLn " 나는 친구와 영화를 봤다. "</code> 를 <em>준비</em>하고, <code>IO ()</code>를 리턴하면,<br />
<em>※ 주의: 여기서 바로 실행되는게 아닙니다! 그래서 준비라고 표현했습니다.</em><br />
<code>&lt;-</code>로 <code>IO</code>를 벗기면 <code>a</code>는 <code>()</code>가 됩니다.</p></li>
<li><p>안 쪽의 람다 함수<code>(\_ -&gt; act2)</code>에 <code>()</code>를 넣어주면 <code>act2</code> 만 남고</p></li>
</ol>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>runReaderT act2 <span class="st">&quot;친구&quot;</span></span></code></pre></div>
<p><code>act2</code>는 <code>IO</code>작업 <code>putStrLn " 나는 친구와 밥을 먹었다. "</code>를 <em>준비</em>하고, <code>IO ()</code>를 리턴합니다.</p>
<p>결론은 <code>act1</code>에 <code>"친구"</code>를 넣어 <code>IO</code> 액션을 만들고, 그 다음 <code>act2</code>에 <code>"친구"</code>를 넣어 <code>IO</code> 액션을 만들어서, 바인드의 결과는 <code>IO</code> 액션을 엮어 놓은 상태가 됐습니다.<br />
<code>IO</code> 액션 엮음chaining은 GHCi에서 이 엮음에 realworld 환경값을 넣어주면서 실행하게 됩니다. (<code>IO</code> 모나드의 실행)<br />
(이 품고 품게 엮은 모양을 뭐라 번역하면 좋을까요?)</p>
<p><code>ReaderT</code>의 바인드를 보면 두 개의 바인드가 실행되는 게 보이나요?</p>
<p>아직은 그다지 좋은 설명이 아닌 것 같긴한데, 일단 포스팅해 놨습니다.<br />
여기서 강조하고 싶은 건 모나드 트랜스포머의 바인드는 당연히 <em>합쳐진 모든 모나드의 바인드를 실행</em>한다 입니다.</p>
<h2 id="mtl">mtl</h2>
<h3 id="return-type-polymorphic">Return Type Polymorphic</h3>
<p><code>act1</code>의 리턴 타입을 하드 코딩하지 않고, GHC에게 떠넘기는 방법이 있습니다. Reader와 IO가 섞여 있는 걸 <code>ReaderT String IO ()</code> 같이 고정된 타입으로 만들지 않고, GHC가 알아서 타입을 결정하게 만들면 좀 더 유연하게 쓸 수 있습니다. 꼭 <code>ReaderT String IO ()</code> 컨텍스트에서만 동작하는게 아니라, MonadReader 인스턴스이고, MonadIO 인스턴스이기만 하면, 어떤 컨텍스트에서건 불러다 쓸 수 있게 됩니다. 어떻게 이렇게 동작할 수 있는지 <a href="../posts/2021-04-13-class_constraint.html">클래스 제약</a> 포스트를 보면 도움이 됩니다.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# Language FlexibleContexts #-}</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Control.Monad.IO.Class</span> ( <span class="dt">MonadIO</span>(..) )</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Control.Monad.Reader</span> ( <span class="dt">MonadReader</span>, <span class="dt">ReaderT</span>, runReaderT, ask )</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="ot">act1 ::</span> (<span class="dt">MonadReader</span> <span class="dt">String</span> m, <span class="dt">MonadIO</span> m) <span class="ot">=&gt;</span> m ()</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>act1 <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  who <span class="ot">&lt;-</span> ask</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  liftIO <span class="op">$</span> <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;나는 &quot;</span> <span class="op">++</span> who <span class="op">++</span> <span class="st">&quot;와 영화를 봤다. &quot;</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">--act2 :: (MonadReader String m, MonadIO m) =&gt; m ()</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="ot">act2 ::</span> <span class="dt">ReaderT</span> <span class="dt">String</span> <span class="dt">IO</span> ()</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>act2 <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  who <span class="ot">&lt;-</span> ask</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  liftIO <span class="op">$</span> <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;나는 &quot;</span> <span class="op">++</span> who <span class="op">++</span> <span class="st">&quot;와 밥을 먹었다. &quot;</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="ot">act3 ::</span> (<span class="dt">MonadReader</span> <span class="dt">String</span> m, <span class="dt">MonadIO</span> m) <span class="ot">=&gt;</span> m ()</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>act3 <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  who <span class="ot">&lt;-</span> ask</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  liftIO <span class="op">$</span> <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;나는 &quot;</span> <span class="op">++</span> who <span class="op">++</span> <span class="st">&quot;와 술을 먹었다. &quot;</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="ot">act ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>act who <span class="ot">=</span> runReaderT ( <span class="kw">do</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    act1</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    act2</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    act3</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>  ) who </span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> <span class="kw">do</span> act <span class="st">&quot;친구</span></span></code></pre></div>
<p><code>act1</code>, <code>act2</code>, <code>act3</code> 함수들을 모두 <code>ReaderT</code> 컨텍스트 안에서 사용 가능합니다. <code>act1</code> ,<code>act3</code>과 <code>act2</code>는 결과 타입이 달라 보이지만, GHC가 나중에 추론해서 <code>act1</code>도 <code>act3</code>도 <code>ReaderT String IO ()</code>로 맞춰지게 됩니다. parameteric 다형성, ad-hoc 다형성처럼 결과 타입에 정해지지 않은 타입 m을 써주는 것에 대한 용어가 있을 것 같은데, 따로 이름은 찾지 못했고, 그냥 <em>Return type polymorphic</em> 이라 부르는 것 같습니다.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ot">{-# Language FlexibleContexts #-}</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Control.Monad.IO.Class</span> ( <span class="dt">MonadIO</span>(..) )</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Control.Monad.Reader</span> ( <span class="dt">MonadReader</span>, <span class="dt">ReaderT</span>, runReaderT, ask )</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">-- act1 :: IO () 이렇게 타입을 고정하면 IO 컨텍스트에서만 act1을 부를 수 있습니다.</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">-- MonadIO m =&gt; 으로 지정하면 IO 컨텍스트에서 불러 쓸 수 있고, ReaderT Int IO 컨텍스트에서도 그대로 불러 쓸 수 있습니다.</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="ot">act1 ::</span> (<span class="dt">MonadIO</span> m) <span class="ot">=&gt;</span> m ()</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>act1 <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  liftIO <span class="op">$</span> <span class="fu">putStrLn</span> <span class="op">$</span> <span class="st">&quot;어떤 컨텍스트 안에서든 쓸 수 있어요.&quot;</span> </span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="ot">act2 ::</span> (<span class="dt">MonadReader</span> <span class="dt">Int</span> m, <span class="dt">MonadIO</span> m) <span class="ot">=&gt;</span> m ()</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>act2 <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    num <span class="ot">&lt;-</span> ask</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    liftIO <span class="op">$</span> <span class="fu">print</span> num</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="ot">act3 ::</span> (<span class="dt">MonadReader</span> <span class="dt">Int</span> m) <span class="ot">=&gt;</span> m ()</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>act3 <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    num <span class="ot">&lt;-</span> ask</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span> ()</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a><span class="ot">acts ::</span> <span class="dt">ReaderT</span> <span class="dt">Int</span> <span class="dt">IO</span> ()</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>acts <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    act1</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    act2</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    act3</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> <span class="kw">do</span> liftIO <span class="op">$</span> runReaderT acts <span class="dv">1</span></span></code></pre></div>
<p><code>act1</code>, <code>act2</code>, <code>act3</code> 모두 <code>ReaderT</code>로 추론되고,<br />
<code>act1</code>의 조립 조건 <code>(MonadIO m) =&gt;</code> 을 만족하는 <code>instance MonadIO ReaderT...</code>가 있으니 OK<br />
<code>act2</code>의 조립 조건 <code>(MonadReader Int m, MonadIO m) =&gt;</code> 을 만족하는 <code>instance MonadReader ReaderT...</code>, <code>instance MonadIO ReaderT...</code>가 있으니 OK<br />
<code>act3</code>의 조립 조건 <code>(MonadReader Int m) =&gt;</code> 을 만족하는 <code>instance MonadReader ReaderT...</code>가 있으니 OK</p>
<p>미리 준비되어 있는 <code>MonadReader</code>의 인스턴스는 <code>MaybeT</code>, <code>ListT</code>, <code>WriterT</code>, <code>StateT</code>, <code>IdentityT</code>, <code>ExceptT</code>, <code>ErrorT</code>, <code>ContT</code>, <code>ReaderT</code>, <code>RWST</code> 용 인스턴스가 있습니다. <code>acts</code>의 리턴 타입(또는 컨텍스트라 말하기도 합니다.)이 <code>ReaderT</code> 타입이니, <code>act2</code>의 타입도 <code>ReaderT</code> 타입으로 추론하고, <code>ReaderT</code>용 <code>ask</code>를 가져옵니다.<br />
<a href="https://hackage.haskell.org/package/mtl-2.2.2/docs/Control-Monad-Reader.html#g:1" class="uri">https://hackage.haskell.org/package/mtl-2.2.2/docs/Control-Monad-Reader.html#g:1</a></p>
<p>미리 준비되어 있는 <code>MonadIO</code>의 인스턴스는 <code>MonadIO</code>쪽에서 선언되어 있지 않고, <code>ReaderT</code>나 <code>WriterT...</code> 각각에서 볼 수 있습니다. <a href="https://hackage.haskell.org/package/mtl-2.2.2/docs/Control-Monad-Reader.html#g:3" class="uri">https://hackage.haskell.org/package/mtl-2.2.2/docs/Control-Monad-Reader.html#g:3</a></p>
<p><code>main</code> 을 다음과 같이 쓰면 <code>ReaderT</code> 타입은 보이지 않아 처음에는 다른 컨텍스트로 오해할 수도 있지만, <code>runReaderT</code>를 보고 알 수 있습니다.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> liftIO <span class="op">$</span> runReaderT ( <span class="kw">do</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>           act1</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>           act2</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>           act3 </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>       ) </span></code></pre></div>
<h3 id="mtl-핵심-아이디어">mtl 핵심 아이디어</h3>
<p>모나드 트랜스포머를 3개 이상 겹치기 시작하면 상황이 복잡해지기 시작합니다. 예를 들어 <code>ListT</code>, <code>ReaderT</code>,<code>LoggerT</code>, <code>IO</code> 의 성격이 모두 들어 있는 컨텍스트 안에서 <code>ask</code>를 실행하려면 <code>ReaderT</code>가 몇 번째로 쌓여 있는지 알아야 실행할 수 있습니다. 모나드 트랜스포머는 모두 <code>MonadTrans</code>의 인스턴스여서 <code>lift</code> 메소드를 가지고 있습니다. <code>lift</code> 함수를 이용하면 모나드 스택에서 실행할 수 있습니다. 그런데 쌓아 올린 모양에 따라 <code>lift . ask</code> 로 실행해야 하는지, <code>lift . lift . ask</code> 로 실행해야 하는지 알아야 합니다.</p>
<p>※ 이렇게 몇 개의 모나드 트랜스포머로 쌓여 있는 걸 <em>모나드 스택</em>이라 부릅니다.</p>
<figure>
<img src="../images/mtl.png" alt="몇 층에 있든 알아서 해" /><figcaption aria-hidden="true">몇 층에 있든 알아서 해</figcaption>
</figure>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">MonadReader</span> r m <span class="op">|</span> m <span class="ot">-&gt;</span> r <span class="kw">where</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    ask ::</span> m r</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    ask <span class="ot">=</span> reader <span class="fu">id</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">...</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="ot">    reader ::</span> (r <span class="ot">-&gt;</span> a) <span class="ot">-&gt;</span> m a</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    reader f <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>       r <span class="ot">&lt;-</span> ask <span class="co">------------ (1)</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>       <span class="fu">return</span> (f r)</span></code></pre></div>
<p>(1)번 <code>ask</code>는 어떤 <code>ask</code>가 실행될까요? <code>reader</code> 메소드는 <code>m a</code> 컨텍스트에 있습니다. 모나드 <code>m</code>에 있는 <code>ask</code>를 실행할거라 예상할 수 있습니다. 만일 <code>m</code>이 <code>ListT</code>이면</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">MonadReader</span> r m <span class="ot">=&gt;</span> <span class="dt">MonadReader</span> r (<span class="dt">ListT</span> m) <span class="kw">where</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    ask<span class="co">--(1)   </span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>       <span class="ot">=</span> lift ask <span class="co">---------- (2)</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    local <span class="ot">=</span> mapListT <span class="op">.</span> local</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    reader <span class="ot">=</span> lift <span class="op">.</span> reader</span></code></pre></div>
<p><code>MonadReader r (ListT m)</code> 인스턴스에 있는 <code>ask</code>를 실행합니다. 그럼 (2)번은 어디에 있는 <code>ask</code>일까요? <code>ask</code> 선언에 따라 <code>lift ask</code> 는 <code>(ListT m)</code> 타입이고, 그럼 ask는 리프팅 되어 <code>(ListT m)</code> 타입이니 <code>m</code>타입입니다. <code>m</code> 타입이 <code>ReaderT</code> 타입이라면</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Monad</span> m <span class="ot">=&gt;</span> <span class="dt">MonadReader</span> r (<span class="dt">ReaderT</span> r m) <span class="kw">where</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    ask<span class="co">--(2) </span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>       <span class="ot">=</span> ReaderT.ask <span class="co">--------- (3)</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    local <span class="ot">=</span> ReaderT.local</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    reader <span class="ot">=</span> ReaderT.reader</span></code></pre></div>
<p>(3)번 <code>ask</code>를 실행하게 됩니다. 조금 복잡하지만 결론은 <em>GHC가 알아서 ask구현을 찾아 갔습니다.</em> 모나드 스택의 몇 번째 층에 <code>ReaderT</code>가 있든, GHC가 알아서 <code>ask</code>구현을 찾아 갈 수 있습니다. 이게 <em>mtl의 핵심 아이디어</em>입니다.</p>
<p>참고 - <a href="../posts/2020-07-21-mtlStyle.html">Has Type class 패턴 포스트</a></p>
<h2 id="자주-만나는-에러-no-instance">자주 만나는 에러 No instance</h2>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ot">somefunc ::</span> (<span class="dt">MonadIO</span> m, <span class="dt">MonadReader</span> c m) <span class="ot">=&gt;</span> <span class="op">...</span> <span class="ot">-&gt;</span> m ()</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="op">...</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> somefunc <span class="op">...</span></span></code></pre></div>
<p>아래 에러가 납니다.</p>
<pre><code>    • No instance for (MonadReader IO)
        arising from a use of ‘somefunc</code></pre>
<p><code>somefunc</code>에선 Return Type Polymorphic과 constraint를 이용해 타입 추론을 뒤로 미뤘습니다. 나중에 <code>somefunc</code>가 불릴 컨텍스트가 <code>MonadIO</code>, <code>MonadReader</code> 인스턴스인지 체크해야 합니다. 지금 코드는 IO 컨텍스트 안에서 불렀습니다. 그럼 <code>instance MonadIO IO</code> , <code>instance MonadReader c IO</code> 가 있어야 하는데, <code>instance MonadReader IO</code> 는 정의되어 있지 않다는 에러입니다. <code>MonadReader</code> 쪽을 보면 실제로 <code>IO</code> 인스턴스는 정의되어 있지 않습니다.</p>
<p>※ 그럼 <code>MonadReader</code>는 다른 트랜스포머용 인스턴스는 모두 정의해 놨는데, 왜 <code>IO</code>는 정의해놓지 않았을까요? <code>MonadReader</code>는 <code>ask</code>메소드를 계층에 상관없이 편리하게 쓰기 위해 정의한 클래스입니다. <em>어떤 트랜스포머로 쌓여 있든, 결국 ReaderT모나드의 ask등의 메소드를 찾아 갈 수 있게 만들어 놓은 겁니다.</em> <code>IO</code>는 모나드 스택에서 항상 바닥에 있는 모나드이므로 <code>IO</code>까지 도달하면 더 진행할 수 가 없습니다. 만일 <code>IOT</code>같은 <code>IO</code> 트랜스포머가 있다면 얘기는 달라질 겁니다.</p>
<p>※ 그럼 <code>MonadIO IO</code> 인스턴스가 없다는 에러는 왜 안 났을까요?</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">MonadIO</span> <span class="dt">IO</span> <span class="kw">where</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    liftIO <span class="ot">=</span> <span class="fu">id</span></span></code></pre></div>
<p><code>Monad IO</code> 인스턴스는 정의 되어있습니다.</p>
<p>※ <code>IO</code>의 트랜스포머 <code>IOT</code>는 왜 없을까요?<br />
http://h2.jaguarpaw.co.uk/posts/io-transformer/</p>
<h2 id="에러-수정">에러 수정</h2>
<p>다른 부분 수정없이 <code>runReaderT</code>로 환경값을 먹이면 컴파일 됩니다. 왜 그럴까요?</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> runReaderT somefunc <span class="op">...</span> 환경값 <span class="op">...</span></span></code></pre></div>
<p><code>runReaderT</code>는 <code>ReaderT</code>를 받으니, GHC는 <code>somefunc</code>가 <code>ReaderT</code>타입일거라 추론합니다. GHC가 추적에 이용한 단서는 <code>MonadReader</code> 인스턴스이면 OK라 했습니다. <code>ReaderT</code>는 <code>MonadReader</code>의 인스턴스이니 문제가 없습니다. <code>runReaderT</code>로 <code>ReaderT</code>를 벗겨내면 만나는 컨텍스트는 <code>main :: IO ()</code> 이니, <code>ReaderT</code> 안에 들어 있는 모나드는 <code>IO</code>입니다. <code>somefunc</code>의 리턴 타입 <code>m</code> 추론이 끝났습니다. <em>타입이 모호하지 않게 타입 지정을 해 준게 아니라, 타입 추론이 막히지 않도록 단서를 추가</em>해 준 거라 봐도 됩니다.</p>

<div class="comment">
<script src="https://utteranc.es/client.js" repo="lionhairdino/lionhairdino.github.io" issue-term="url" theme="github-light" crossorigin="anonymous" async>
</script>
</div>
        </div>
        <div id="footer">
            © 2021 lionhairdino. All rights reserved. Generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </div>
    </body>
</html>
